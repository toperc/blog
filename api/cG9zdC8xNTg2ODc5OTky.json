{"title":"WebView高度自适应方案探究","date":"2020-04-14T15:59:52.000Z","date_formatted":{"ll":"2020年4月14日","L":"2020/04/14","MM-DD":"04-14"},"link":"post/1586879992","comments":true,"tags":["WebView"],"categories":["Android"],"updated":"2021-01-14T08:08:54.907Z","content":"<p>Android项目开发中针对webview避免不了混合开发模式，可Android上的webview又很不争气，几乎每个Android版本都有webvie的改动，在国内这种鱼龙混杂环境下出乎意料的问题又很多，这次就谈谈webview高度自适应的问题。</p>\n<a id=\"more\"></a>\n<h2 id=\"问题\">问题<a title=\"#问题\" href=\"#问题\"></a></h2>\n<p>在Android开发生涯中想必大家都遇到过，webview在有些时候展示不完整，在某些时候底部有一片空白，有些时候始终又滑不到底。。。导致这个问题的原因常见有以下三种：</p>\n<ul>\n<li>网页高度不固定</li>\n<li>嵌套布局导致webview的高度无法自适应</li>\n<li>系统原因导致webview在某种特殊情况下不能兼容当前应用的屏幕分辨率</li>\n</ul>\n<p>下边就分别说说这三种情况引起的原因以及解决方法。</p>\n<h2 id=\"针对网页高度不固定问题\">针对网页高度不固定问题<a title=\"#针对网页高度不固定问题\" href=\"#针对网页高度不固定问题\"></a></h2>\n<p>这部分原因和H5编写方法有很大关系，例如Ajax异步处理结果过慢，webview的高度不能及时更新；也有可能H5编写时预留了一个资源展示区等待将来资源展示，结果资源没有加载出来。这个和H5开发人员说明一下情况，检查一下代码结构。</p>\n<h2 id=\"针对嵌套布局导致webview高度不固定问题\">针对嵌套布局导致webview高度不固定问题<a title=\"#针对嵌套布局导致webview高度不固定问题\" href=\"#针对嵌套布局导致webview高度不固定问题\"></a></h2>\n<p>这个是Android开发最常见的事，很多时候是混合开发模式，不得已采用scrollview嵌套webview,但是我们知道scrollview中嵌套其他view常常使某些view的高度（match_parent）失效，当然你可以采用<code>android:fillViewport=&quot;true&quot;</code>强制让其撑满，但是似乎其内部的webview又不听话了，这个道理很明显，毕竟webview渲染的是网页，也即是我们能够准确固定webview高度这个问题就迎刃而解了。</p>\n<h2 id=\"针对webview兼容当前应用屏幕密度问题\">针对webview兼容当前应用屏幕密度问题<a title=\"#针对webview兼容当前应用屏幕密度问题\" href=\"#针对webview兼容当前应用屏幕密度问题\"></a></h2>\n<p>首先我们要处理的是避免系统字体的缩放影响webview缩放，我们可以用<code>webview.getSettings().setTextZoom(100)</code>来避免。其余的支持自适应即可，在应用屏幕密度设定之后webiview可自动匹配，当然也有一些奇葩设备（被应用商修改过），这部分我们可以忽略了。</p>\n<h2 id=\"针对高度不固定问题解决方案\">针对高度不固定问题解决方案<a title=\"#针对高度不固定问题解决方案\" href=\"#针对高度不固定问题解决方案\"></a></h2>\n<p>我这里给出两种解决方案。</p>\n<h3 id=\"布局结构调整\">布局结构调整<a title=\"#布局结构调整\" href=\"#布局结构调整\"></a></h3>\n<p>按照官方建议webiview父布局高度采用<code>match_parent</code>。</p>\n<h3 id=\"webview根据网页的高度自动扩展自身高度：\">WebView根据网页的高度自动扩展自身高度：<a title=\"#webview根据网页的高度自动扩展自身高度：\" href=\"#webview根据网页的高度自动扩展自身高度：\"></a></h3>\n<p>我们按照步骤走：</p>\n<p><strong>第一步</strong>：本地定义Js交互接口，通常H5需要明确这个接口标识，Android端才能回调相关内容给H5。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mWebView.addJavascriptInterface(<span class=\"keyword\">this</span>, <span class=\"string\">&quot;App&quot;</span>);</span><br></pre></td></tr></table></figure>\n<p><strong>第二步</strong>：本地实现接口方法，H5通过上边的“APP”接口标识能调用本地该接口里面的方法。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * js回调，重新计算webview的高度。</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@JavascriptInterface</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">resize</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">float</span> clientWidth, <span class=\"keyword\">final</span> <span class=\"keyword\">float</span> scrollHeight)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mActivity == <span class=\"keyword\">null</span> || mWebView == <span class=\"keyword\">null</span> || clientWidth == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    mActivity.runOnUiThread(<span class=\"keyword\">new</span> Runnable() &#123;</span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">float</span> rate = mWebView.getWidth() / clientWidth;</span><br><span class=\"line\">            Log.i(<span class=\"string\">&quot;TAG&quot;</span>, <span class=\"string\">&quot;webview---------clientWidth:&quot;</span> + clientWidth + <span class=\"string\">&quot;---------scrollHeight:&quot;</span> + scrollHeight + <span class=\"string\">&quot;---------rate:&quot;</span> + rate);</span><br><span class=\"line\">            mWebView.setLayoutParams(<span class=\"keyword\">new</span> LinearLayout.LayoutParams(LinearLayout.LayoutParams.MATCH_PARENT,</span><br><span class=\"line\">                    (<span class=\"keyword\">int</span>) (scrollHeight * rate)));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>第三步</strong>：本地调用H5的js方法，告诉H5：“我，大Android，需要你H5现在的宽和高”，然后H5乖乖的把界面上宽高回调给本地，就是第二步的方法。但是！我今天说的这个是通用方式，是针对所有的H5的，不可能让每个H5都定义一个js方法供Android端调用，怎么办呢？好办，直接让H5回调本地方法：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mWebView.loadUrl(<span class=\"string\">&quot;javascript:App.resize(document.documentElement.clientWidth, document.documentElement.scrollHeight)&quot;</span>);</span><br></pre></td></tr></table></figure>\n<p>这里的“App”其实就是“this”，那么js回调时机是什么时候呢，我是希望这个页面加载结束的时候告诉我，所以重写WebViewClient里面的<code>onPageFinished</code>方法。由于有些H5采用异步加载的方式，我不知道他到底什么时候完全加载出来，所以这里我分多次让H5帮我回调：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DefaultWebViewClient</span> <span class=\"keyword\">extends</span> <span class=\"title\">WebViewClient</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//页面内跳转</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">shouldOverrideUrlLoading</span><span class=\"params\">(WebView webView, String s)</span> </span>&#123;</span><br><span class=\"line\">        webView.loadUrl(s);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onPageFinished</span><span class=\"params\">(WebView webView, String s)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>.onPageFinished(webView, s);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//执行网页高度获取，不断获取网页高度</span></span><br><span class=\"line\">        mHandler.post(<span class=\"keyword\">new</span> Runnable() &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//执行最大次数</span></span><br><span class=\"line\">            <span class=\"keyword\">int</span> times = <span class=\"number\">5</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (times &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                    mWebView.loadUrl(<span class=\"string\">&quot;javascript:App.resize(document.documentElement.clientWidth, document.documentElement.scrollHeight)&quot;</span>);</span><br><span class=\"line\">                    mHandler.postDelayed(<span class=\"keyword\">this</span>, <span class=\"number\">1000</span>);</span><br><span class=\"line\">                    times--;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"总结\">总结<a title=\"#总结\" href=\"#总结\"></a></h2>\n<p>以上是我针对该类问题想到的一些处理方案，大家有更好的处理方式不妨也分享一下，集思广路，一同进步。</p>\n","prev":{"title":"各地隔离政策查询","link":"post/1"},"next":{"title":"更好的人生一定要学会做减法","link":"post/1586535410"},"plink":"https://blog.ixin.run/post/1586879992/","toc":[{"id":"问题","title":"问题","index":"1"},{"id":"针对网页高度不固定问题","title":"针对网页高度不固定问题","index":"2"},{"id":"针对嵌套布局导致webview高度不固定问题","title":"针对嵌套布局导致webview高度不固定问题","index":"3"},{"id":"针对webview兼容当前应用屏幕密度问题","title":"针对webview兼容当前应用屏幕密度问题","index":"4"},{"id":"针对高度不固定问题解决方案","title":"针对高度不固定问题解决方案","index":"5","children":[{"id":"布局结构调整","title":"布局结构调整","index":"5.1"},{"id":"webview根据网页的高度自动扩展自身高度：","title":"WebView根据网页的高度自动扩展自身高度：","index":"5.2"}]},{"id":"总结","title":"总结","index":"6"}],"reward":true,"copyright":{"custom":"转载请注明出处，谢谢支持。"}}