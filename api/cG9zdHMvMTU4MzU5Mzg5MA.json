{"title":"Edittext的自动填充引起的Bug","date":"2020-03-07T15:11:30.000Z","date_formatted":{"ll":"2020年3月7日","L":"2020/03/07","MM-DD":"03-07"},"link":"posts/1583593890","comments":true,"tags":["Android","Bug"],"categories":["Android"],"updated":"2021-02-03T01:43:33.484Z","content":"<p>最近发现线上有一个bug：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">at com.android.internal.util.SyncResultReceiver.waitResult(SyncResultReceiver.java:<span class=\"number\">60</span>)</span><br><span class=\"line\">at com.android.internal.util.SyncResultReceiver.getIntResult(SyncResultReceiver.java:<span class=\"number\">68</span>)</span><br><span class=\"line\">at android.view.autofill.AutofillManager.ensureServiceClientAddedIfNeededLocked(AutofillManager.java:<span class=\"number\">1847</span>)</span><br><span class=\"line\">at android.view.autofill.AutofillManager.notifyViewEnteredLocked(AutofillManager.java:<span class=\"number\">966</span>)</span><br><span class=\"line\">at android.view.autofill.AutofillManager.notifyViewEntered(AutofillManager.java:<span class=\"number\">950</span>)</span><br><span class=\"line\">at android.view.autofill.AutofillManager.notifyViewEntered(AutofillManager.java:<span class=\"number\">901</span>)</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n<p>并且只出现在Android10上，经查询原来是Edittext默认开启自动填充功能引起的，本片就简单了解一下自动Edittext自动填充功能，以及相应bug的解决方式。</p>\n<a id=\"more\"></a>\n<h3 id=\"背景\">背景<a title=\"#背景\" href=\"#背景\"></a></h3>\n<p>在Android 8.0中加入了Autofill framework，也就是自动填充框架，目的在于简化了登录和信用卡表单之类表单的填写工作。如果一个应用支持自动填充，系统从用户的Google账户保存的自动填充信息中选取相应的内容来填充当前输入框，比如，一个登录页面的手机号码输入栏，自动填充的推荐内容则是当前用户的手机号码。</p>\n<h2 id=\"使用\">使用<a title=\"#使用\" href=\"#使用\"></a></h2>\n<p>作为一个开发者，如何来控制自动填充功能呢？在Android O Developer Preview 3中google提供了一些解决办法，即从sdk26开始，所有的视图中新增了一个android:importantForAutofill的属性，以及相应的一个方法setImportantForAutofill()来控制自动填充功能。</p>\n<p>当然我们也可以在代码中(Activity的onCreat中)强制请求自动填充：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public void forceAutofill() &#123;</span><br><span class=\"line\"> AutofillManager afm &#x3D; context.getSystemService(AutofillManager.class);</span><br><span class=\"line\"> if (afm!&#x3D; null) &#123;</span><br><span class=\"line\">    afm.requestAutofill();</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"解决bug\">解决Bug<a title=\"#解决bug\" href=\"#解决bug\"></a></h2>\n<p>自动填充功能很好，但是在某些安全性要求较高或者某些特殊的页面，自动填充不再是一个优势，反而带来影响的时候，另外开篇出现的bug是在Android10默认开启自动填充功能引起的，所以针对这些我们一般会屏蔽自动填充功能。屏蔽方法也很简单：</p>\n<p>1.在XML中实现</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">android:importantForAutofill&#x3D;&quot;no&quot;</span><br></pre></td></tr></table></figure>\n<p>2.在代码中实现</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onCreate</span><span class=\"params\">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">super</span>.onCreate(savedInstanceState);</span><br><span class=\"line\">    disableAutoFill();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@TargetApi(Build.VERSION_CODES.O)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">disableAutoFill</span><span class=\"params\">()</span> </span>&#123; </span><br><span class=\"line\">    getWindow().getDecorView().setImportantForAutofill(View.IMPORTANT_FOR_AUTOFILL_NO_EXCLUDE_DESCENDANTS);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里我建议第二种直接写在BaseActivity中，<strong>切记判断版本Android O以上才可以</strong>。</p>\n","prev":{"title":"健康小记","link":"posts/1584787534"},"next":{"title":"记一次BuildConfig.DEBUG不准确导致的Bug","link":"posts/1576077775"},"plink":"https://blog.ixin.run/posts/1583593890/","toc":[{"id":"背景","title":"背景","index":"1"}],"reward":true,"copyright":{"author":"i猩人","link":"<a href=\"https://blog.ixin.run/posts/1583593890/\" title=\"Edittext的自动填充引起的Bug\">https://blog.ixin.run/posts/1583593890/</a>","license":"本文遵循<a href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/\"rel=\"external nofollow\" target=\"_blank\"> CC 4.0 BY-SA </a>版权协议，转载请附上原文出处链接及本声明。"}}