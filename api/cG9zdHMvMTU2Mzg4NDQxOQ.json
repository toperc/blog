{"title":"Android数据库GreenDao的使用完全解析","date":"2019-07-23T12:20:19.000Z","date_formatted":{"ll":"2019年7月23日","L":"2019/07/23","MM-DD":"07-23"},"link":"posts/1563884419","comments":true,"tags":["SQLite","数据持久化"],"categories":["Android"],"updated":"2021-01-29T12:51:44.642Z","content":"<p>最近一直在处理公司项目本地数据库，原来的订单数据都是采用SP加密保存的，但SP仅仅适合数据量小的数据存储，随着功能的扩展发现数据越来越多越来越杂，所以这部分数据全部迁移到本地数据库还是有必要的，之前项目已经采用了Greendao，这块本来也想做个总结，但是greendao知识点比较丰富，后来上网发现别人总结的一篇很全面——<a href=\"https://www.jianshu.com/p/53083f782ea2\" target=\"_blank\">《一篇技术好文之Android数据库 GreenDao的使用完全解析》</a>，这里就做一个转载记录，方便工作过程中查阅调优。<strong>另外特别说明一下Greendao官方已经不再维护了</strong>，替代方案也有很多，例如<code>ObjectBox</code>（与Greendao同一公司）、<code>Realm</code>、<code>Room</code>（Google官方）等。本篇也有额外说明，如果想更好的使用Greendao，请结合另外一篇<a href=\"https://blog.csdn.net/sinat_15877283/article/details/51098477\" target=\"_blank\">《DataBase 数据库整理（greenDao示例）》</a>查看，会起到事半功倍的效果。</p>\n<blockquote>\n<p>本文主要从如下几个方面进行讲解：</p>\n<ol>\n<li>存储的数据库结构</li>\n<li>GreenDao的优缺点</li>\n<li>GreenDao的使用配置</li>\n<li>使用GreenDao实现数据的增删改查</li>\n<li>GreenDao的注解使用</li>\n<li>GreenDao的关系处理</li>\n<li>GreenDao的升级</li>\n<li>GreenDao数据库加密</li>\n<li>项目地址</li>\n<li>总结</li>\n<li>参考博客</li>\n</ol>\n</blockquote>\n<a id=\"more\"></a>\n<h2 id=\"存储的数据库结构\">存储的数据库结构<a title=\"#存储的数据库结构\" href=\"#存储的数据库结构\"></a></h2>\n<p>学习数据库之前，我们先得设计自己的数据库，不多废话，下面是我此次学习的数据库结构，后面所有的数据请参考这个图进行学习：</p>\n<p><img src=\"https://note.youdao.com/yws/api/personal/file/513554934D984DB0B596D7E67852B1C2?method=download&amp;shareKey=b400014ae41870f1ff8179b11ff26d99\" alt=\"GreenDao关系图\" class=\"φbs\"></p>\n<h2 id=\"greendao的介绍\">GreenDao的介绍<a title=\"#greendao的介绍\" href=\"#greendao的介绍\"></a></h2>\n<p>简单的GreenDao的介绍，嫌麻烦的可以直接跳到GreenDao使用开始看。</p>\n<h3 id=\"什么是greendao？\">什么是GreenDao？<a title=\"#什么是greendao？\" href=\"#什么是greendao？\"></a></h3>\n<p>GreenDAO是一个开源的Android ORM(“对象/关系映射”)，通过ORM（称为“对象/关系映射”），在我们数据库开发过程中节省了开发时间！<br>\n<img src=\"https://note.youdao.com/yws/api/personal/file/C074FF366A0749B982ECCB6A5D3F5103?method=download&amp;shareKey=ca2b3eb688b4c92c9cc294911eeac593\" alt=\"GreenDao的原理图\"></p>\n<h3 id=\"greendao的官方文档\">GreenDao的官方文档<a title=\"#greendao的官方文档\" href=\"#greendao的官方文档\"></a></h3>\n<ol>\n<li><a href=\"http://greenrobot.org/greendao/\" target=\"_blank\">GreenDao：适用于您的SQLite数据库的Android ORM</a></li>\n<li><a href=\"https://github.com/greenrobot/greenDAO\" target=\"_blank\">GreenDao的github地址</a></li>\n<li><a href=\"https://groups.google.com/forum/#!forum/greendao\" target=\"_blank\">GreenDao的Google讨论区</a></li>\n<li><a href=\"https://www.zetetic.net/sqlcipher/sqlcipher-for-android/\" target=\"_blank\">GreenDao 加密SQLCipher for Android官方说明地址</a></li>\n<li><a href=\"http://greenrobot.org/greendao/documentation/\" target=\"_blank\">GreenDao使用文档</a></li>\n</ol>\n<h3 id=\"greendao的作用\">GreenDao的作用<a title=\"#greendao的作用\" href=\"#greendao的作用\"></a></h3>\n<p>通过GreenDao，我们可以更快速的操作数据库，我们可以使用简单的面相对象的API来存储，更新，删除和查询Java对象。</p>\n<h3 id=\"greendao的优缺点\">GreenDao的优缺点<a title=\"#greendao的优缺点\" href=\"#greendao的优缺点\"></a></h3>\n<ol>\n<li>高性能，下面是官方给出的关于GreenDao，OrmLite和ActiveAndroid三种ORM解决方案的数据统计图：<br>\n<img src=\"https://note.youdao.com/yws/api/personal/file/AE10ACF2655F4F6E88EEA905FCE27602?method=download&amp;shareKey=9debd5eb32a45c41f848a5129d1f90e7\" alt=\"GreenDao性能对比图\"></li>\n<li>易于使用的强大API，涵盖关系和连接；</li>\n<li>最小的内存消耗;</li>\n<li>小库大小（&lt;100KB）以保持较低的构建时间并避免65k方法限制;</li>\n<li>数据库加密：greenDAO支持SQLCipher，以确保用户的数据安全;</li>\n</ol>\n<h2 id=\"greendao的使用\">GreenDao的使用<a title=\"#greendao的使用\" href=\"#greendao的使用\"></a></h2>\n<p>GreenDao的核心类有三个：分别是DaoMaster,DaoSession,XXXDao，这三个类都会自动创建，无需自己编写创建！</p>\n<ol>\n<li>DaoMaster:：DaoMaster保存数据库对象（SQLiteDatabase）并管理特定模式的DAO类（而不是对象）。它有静态方法来创建表或删除它们。它的内部类OpenHelper和DevOpenHelper是SQLiteOpenHelper实现，它们在SQLite数据库中创建模式。</li>\n<li>DaoSession：管理特定模式的所有可用DAO对象，您可以使用其中一个getter方法获取该对象。DaoSession还提供了一些通用的持久性方法，如实体的插入，加载，更新，刷新和删除。</li>\n<li>XXXDao：数据访问对象（DAO）持久存在并查询实体。对于每个实体，greenDAO生成DAO。它具有比DaoSession更多的持久性方法，例如：count，loadAll和insertInTx。</li>\n<li>Entities ：可持久化对象。通常, 实体对象代表一个数据库行使用标准 Java 属性(如一个POJO 或 JavaBean )。</li>\n</ol>\n<p><img src=\"https://note.youdao.com/yws/api/personal/file/0DD5F16CE5D34D23B2CADCACCA1203BA?method=download&amp;shareKey=0b848d13027898d373dfdff1b2c1abad\" alt=\"GreenDao核心\" class=\"φbs\"></p>\n<h3 id=\"导入gradle插件和dao代码生成\">导入Gradle插件和Dao代码生成<a title=\"#导入gradle插件和dao代码生成\" href=\"#导入gradle插件和dao代码生成\"></a></h3>\n<p>要在Android项目中使用GreenDao，您需要添加GreenDao Gradle插件并添加GreenDao库：</p>\n<p>导入插件</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 在 Project的build.gradle 文件中添加:</span></span><br><span class=\"line\">buildscript &#123;</span><br><span class=\"line\">    repositories &#123;</span><br><span class=\"line\">        jcenter()</span><br><span class=\"line\">        mavenCentral() <span class=\"comment\">// add repository</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    dependencies &#123;</span><br><span class=\"line\">        classpath <span class=\"string\">&#x27;com.android.tools.build:gradle:3.1.2&#x27;</span></span><br><span class=\"line\">        classpath <span class=\"string\">&#x27;org.greenrobot:greendao-gradle-plugin:3.2.2&#x27;</span> <span class=\"comment\">// add plugin</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>配置相关依赖</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 在 Moudle:app的  build.gradle 文件中添加:</span></span><br><span class=\"line\">apply <span class=\"attr\">plugin:</span> <span class=\"string\">&#x27;com.android.application&#x27;</span></span><br><span class=\"line\">apply <span class=\"attr\">plugin:</span> <span class=\"string\">&#x27;org.greenrobot.greendao&#x27;</span> <span class=\"comment\">// apply plugin</span></span><br><span class=\"line\"> </span><br><span class=\"line\">dependencies &#123;</span><br><span class=\"line\">    implementation <span class=\"string\">&#x27;org.greenrobot:greendao:3.2.2&#x27;</span> <span class=\"comment\">// add library</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>配置数据库相关信息</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">greendao &#123;</span><br><span class=\"line\">    schemaVersion <span class=\"number\">1</span> <span class=\"comment\">//数据库版本号</span></span><br><span class=\"line\">    daoPackage <span class=\"string\">&#x27;com.aserbao.aserbaosandroid.functions.database.greenDao.db&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">// 设置DaoMaster、DaoSession、Dao 包名</span></span><br><span class=\"line\">    targetGenDir <span class=\"string\">&#x27;src.main.java&#x27;</span><span class=\"comment\">//设置DaoMaster、DaoSession、Dao目录,请注意，这里路径用.不要用/</span></span><br><span class=\"line\">    generateTests <span class=\"literal\">false</span> <span class=\"comment\">//设置为true以自动生成单元测试。</span></span><br><span class=\"line\">    targetGenDirTests <span class=\"string\">&#x27;src/main/java&#x27;</span> <span class=\"comment\">//应存储生成的单元测试的基本目录。默认为 src / androidTest / java。</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>配置完成，在Android Studio中使用Build&gt; Make Project，重新build项目，GreenDao集成完成！</p>\n<h3 id=\"创建存储对象实体类\">创建存储对象实体类<a title=\"#创建存储对象实体类\" href=\"#创建存储对象实体类\"></a></h3>\n<p>使用GreenDao存储数据只需要在存储数据类前面声明@Entity注解就让GreenDao为其生成必要的代码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Entity</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Student</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Id(autoincrement = true)</span></span><br><span class=\"line\">    Long id;</span><br><span class=\"line\">    <span class=\"meta\">@Unique</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> studentNo;<span class=\"comment\">//学号</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> age; <span class=\"comment\">//年龄</span></span><br><span class=\"line\">    String telPhone;<span class=\"comment\">//手机号</span></span><br><span class=\"line\">    String sex; <span class=\"comment\">//性别</span></span><br><span class=\"line\">    String name;<span class=\"comment\">//姓名</span></span><br><span class=\"line\">    String address;<span class=\"comment\">//家庭住址</span></span><br><span class=\"line\">    String schoolName;<span class=\"comment\">//学校名字</span></span><br><span class=\"line\">    String grade;<span class=\"comment\">//几年级</span></span><br><span class=\"line\">    ……getter and setter and constructor method……</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">```    </span><br><span class=\"line\"></span><br><span class=\"line\">### GreenDao初始化</span><br><span class=\"line\">我们可以在Application中维持一个全局的会话。我们在Applicaiton进行数据库的初始化操作：</span><br><span class=\"line\">```java</span><br><span class=\"line\"> <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 初始化GreenDao,直接在Application中进行初始化操作</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">initGreenDao</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        DaoMaster.DevOpenHelper helper = <span class=\"keyword\">new</span> DaoMaster.DevOpenHelper(<span class=\"keyword\">this</span>, <span class=\"string\">&quot;aserbao.db&quot;</span>);</span><br><span class=\"line\">        SQLiteDatabase db = helper.getWritableDatabase();</span><br><span class=\"line\">        DaoMaster daoMaster = <span class=\"keyword\">new</span> DaoMaster(db);</span><br><span class=\"line\">        daoSession = daoMaster.newSession();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">private</span> DaoSession daoSession;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> DaoSession <span class=\"title\">getDaoSession</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> daoSession;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>初始化完成之后重新rebuild一下项目会发现在设置的targetGenDir的目录生成三个类文件，这个是GreenDao自动生成的！说明数据库已经连接好了，咱们接下来只需要进行数据库的增删改查操作就行了。Let’s Go!</p>\n<h2 id=\"使用greendao实现增删改查\">使用GreenDao实现增删改查<a title=\"#使用greendao实现增删改查\" href=\"#使用greendao实现增删改查\"></a></h2>\n<h3 id=\"增\">增<a title=\"#增\" href=\"#增\"></a></h3>\n<p>insert() 插入数据</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\">   <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">insertData</span><span class=\"params\">(Thing s)</span> </span>&#123;</span><br><span class=\"line\">    DaoSession daoSession = ((AserbaoApplication) getApplication()).getDaoSession();</span><br><span class=\"line\">           <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">1000</span>; i++) &#123;</span><br><span class=\"line\">              Student student = <span class=\"keyword\">new</span> Student();</span><br><span class=\"line\">                       student.setStudentNo(i);</span><br><span class=\"line\">                       <span class=\"keyword\">int</span> age = mRandom.nextInt(<span class=\"number\">10</span>) + <span class=\"number\">10</span>;</span><br><span class=\"line\">                       student.setAge(age);</span><br><span class=\"line\">                       student.setTelPhone(RandomValue.getTel());</span><br><span class=\"line\">                       String chineseName = RandomValue.getChineseName();</span><br><span class=\"line\">                       student.setName(chineseName);</span><br><span class=\"line\">                       <span class=\"keyword\">if</span> (i % <span class=\"number\">2</span> == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                           student.setSex(<span class=\"string\">&quot;男&quot;</span>);</span><br><span class=\"line\">                       &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                           student.setSex(<span class=\"string\">&quot;女&quot;</span>);</span><br><span class=\"line\">                       &#125;</span><br><span class=\"line\">                       student.setAddress(RandomValue.getRoad());</span><br><span class=\"line\">                       student.setGrade(String.valueOf(age % <span class=\"number\">10</span>) + <span class=\"string\">&quot;年纪&quot;</span>);</span><br><span class=\"line\">                       student.setSchoolName(RandomValue.getSchoolName());</span><br><span class=\"line\">                       daoSession.insert(student);</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n<p>insertOrReplace()数据存在则替换，数据不存在则插入</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">insertData</span><span class=\"params\">(Thing s)</span> </span>&#123;</span><br><span class=\"line\">    DaoSession daoSession = ((AserbaoApplication) getApplication()).getDaoSession();</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">1000</span>; i++) &#123;</span><br><span class=\"line\">                 Student student = <span class=\"keyword\">new</span> Student();</span><br><span class=\"line\">                        student.setStudentNo(i);</span><br><span class=\"line\">                        <span class=\"keyword\">int</span> age = mRandom.nextInt(<span class=\"number\">10</span>) + <span class=\"number\">10</span>;</span><br><span class=\"line\">                        student.setAge(age);</span><br><span class=\"line\">                        student.setTelPhone(RandomValue.getTel());</span><br><span class=\"line\">                        String chineseName = RandomValue.getChineseName();</span><br><span class=\"line\">                        student.setName(chineseName);</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (i % <span class=\"number\">2</span> == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                            student.setSex(<span class=\"string\">&quot;男&quot;</span>);</span><br><span class=\"line\">                        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                            student.setSex(<span class=\"string\">&quot;女&quot;</span>);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                        student.setAddress(RandomValue.getRoad());</span><br><span class=\"line\">                        student.setGrade(String.valueOf(age % <span class=\"number\">10</span>) + <span class=\"string\">&quot;年纪&quot;</span>);</span><br><span class=\"line\">                        student.setSchoolName(RandomValue.getSchoolName());</span><br><span class=\"line\">                        daoSession.insertOrReplace(student);<span class=\"comment\">//插入或替换</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"删\">删<a title=\"#删\" href=\"#删\"></a></h3>\n<p>删除有两种方式：delete()和deleteAll()；分别表示删除单个和删除所有。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\">   <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">deleteData</span><span class=\"params\">(Student s)</span> </span>&#123;</span><br><span class=\"line\">       DaoSession daoSession = ((AserbaoApplication) getApplication()).getDaoSession();</span><br><span class=\"line\">       daoSession.delete(s);</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\">   <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">deleteAll</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">       DaoSession daoSession = ((AserbaoApplication) getApplication()).getDaoSession();</span><br><span class=\"line\">       daoSession.deleteAll(Student.class);</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"改\">改<a title=\"#改\" href=\"#改\"></a></h3>\n<p>通过update来进行修改：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">updataData</span><span class=\"params\">(Student s)</span> </span>&#123;</span><br><span class=\"line\">        DaoSession daoSession = ((AserbaoApplication) getApplication()).getDaoSession();</span><br><span class=\"line\">        daoSession.update(s);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"查\">查<a title=\"#查\" href=\"#查\"></a></h3>\n<p>查询的方法有：</p>\n<ul>\n<li>loadAll()：查询所有数据。</li>\n<li>queryRaw()：根据条件查询。</li>\n<li>queryBuilder() : 方便查询的创建，后面详细讲解。</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> List <span class=\"title\">queryAll</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">       List&lt;Student&gt; students = daoSession.loadAll(Student.class);</span><br><span class=\"line\">       <span class=\"keyword\">return</span> students;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"meta\">@Override</span></span><br><span class=\"line\">   <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">queryData</span><span class=\"params\">(String s)</span> </span>&#123;</span><br><span class=\"line\">      List&lt;Student&gt; students = daoSession.queryRaw(Student.class, <span class=\"string\">&quot; where id = ?&quot;</span>, s);</span><br><span class=\"line\">       mDataBaseAdapter.addNewStudentData(students);</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"querybuilder的使用\">QueryBuilder的使用<a title=\"#querybuilder的使用\" href=\"#querybuilder的使用\"></a></h2>\n<p>编写SQL可能很困难并且容易出现错误，这些错误仅在运行时才会被注意到。该QueryBuilder的类可以让你建立你的实体，而不用SQL自定义查询，并有助于在编译时已检测错误。</p>\n<p>我们先讲下QueryBuilder的常见方法：</p>\n<ul>\n<li>where(WhereCondition cond, WhereCondition… condMore): 查询条件，参数为查询的条件！</li>\n<li>or(WhereCondition cond1, WhereCondition cond2, WhereCondition… condMore): 嵌套条件或者，用法同or。</li>\n<li>and(WhereCondition cond1, WhereCondition cond2, WhereCondition… condMore): 嵌套条件且，用法同and。</li>\n<li>join(Property sourceProperty, Class<J> destinationEntityClass):多表查询，后面会讲。<br>\n输出结果有四种方式，选择其中一种最适合的即可，list()返回值是List,而其他三种返回值均实现Closeable,需要注意的不使用数据时游标的关闭操作：</li>\n<li>list （）所有实体都加载到内存中。结果通常是一个没有魔法的 ArrayList。最容易使用。</li>\n<li>listLazy （）实体按需加载到内存中。首次访问列表中的元素后，将加载并缓存该元素以供将来使用。必须关闭。</li>\n<li>listLazyUncached （）实体的“虚拟”列表：对列表元素的任何访问都会导致从数据库加载其数据。必须关闭。</li>\n<li>listIterator （）让我们通过按需加载数据（懒惰）来迭代结果。数据未缓存。必须关闭。</li>\n<li>orderAsc() 按某个属性升序排；</li>\n<li>orderDesc() 按某个属性降序排；</li>\n</ul>\n<p>GreenDao中SQL语句的缩写，我们也了解下，源码在Property中,使用的时候可以自己点进去查询即可：</p>\n<ul>\n<li>eq()：“equal (‘=?’)” 等于；</li>\n<li>notEq() ：“not equal (‘&lt;&gt;?’)” 不等于；</li>\n<li>like()：&quot; LIKE ?&quot; 值等于；</li>\n<li>between()：&quot; BETWEEN ? AND ?&quot; 取中间范围；</li>\n<li>in()：&quot; IN (&quot;  in命令;</li>\n<li>notIn()：&quot; NOT IN (&quot; not in 命令;</li>\n<li>gt()：“&gt;?”  大于;</li>\n<li>lt()：&quot;&lt;? &quot;  小于;</li>\n<li>ge()：“&gt;=?”  大于等于;</li>\n<li>le()：&quot;&lt;=? &quot;  小于等于;</li>\n<li>isNull()：&quot; IS NULL&quot; 为空;</li>\n<li>isNotNull()：&quot; IS NOT NULL&quot; 不为空;</li>\n</ul>\n<h3 id=\"使用querybuilder进行查询操作\">使用QueryBuilder进行查询操作<a title=\"#使用querybuilder进行查询操作\" href=\"#使用querybuilder进行查询操作\"></a></h3>\n<h4 id=\"简单条件查询\">简单条件查询<a title=\"#简单条件查询\" href=\"#简单条件查询\"></a></h4>\n<p>查询当前Student表的所有的数据：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> List <span class=\"title\">queryAllList</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        DaoSession daoSession = ((AserbaoApplication) getApplication()).getDaoSession();</span><br><span class=\"line\">        QueryBuilder&lt;Student&gt; qb = daoSession.queryBuilder(Student.class);</span><br><span class=\"line\">        List&lt;Student&gt; list = qb.list(); <span class=\"comment\">// 查出所有的数据</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> list;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">```    </span><br><span class=\"line\"></span><br><span class=\"line\">查询Name为“一”的所有Student:</span><br><span class=\"line\">```java</span><br><span class=\"line\"> <span class=\"function\"><span class=\"keyword\">public</span> List <span class=\"title\">queryListByMessage</span><span class=\"params\">(String name)</span></span>&#123;</span><br><span class=\"line\">         DaoSession daoSession = ((AserbaoApplication) getApplication()).getDaoSession();</span><br><span class=\"line\">        QueryBuilder&lt;Student&gt; qb = daoSession.queryBuilder(Student.class);</span><br><span class=\"line\">        QueryBuilder&lt;Student&gt; studentQueryBuilder = qb.where(StudentDao.Properties.Name.eq(<span class=\"string\">&quot;一&quot;</span>)).orderAsc(StudentDao.Properties.Name);</span><br><span class=\"line\">        List&lt;Student&gt; studentList = studentQueryBuilder.list(); <span class=\"comment\">//查出当前对应的数据</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> list;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"原始查询\">原始查询<a title=\"#原始查询\" href=\"#原始查询\"></a></h4>\n<p>通过原始的SQL查询语句进行查询！其实上面有提到QueryBuilder的目的就是方便快捷的编写SQL查询语句，避免我们自己在编写过程中出错！简单介绍下通过QueryBuilder编写数据库，方式方法如下 ：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> List <span class=\"title\">queryListBySqL</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\"><span class=\"comment\">// 查询ID大于5的所有学生</span></span><br><span class=\"line\">        DaoSession daoSession = ((AserbaoApplication) getApplication()).getDaoSession();</span><br><span class=\"line\">        Query&lt;Student&gt; query = daoSession.queryBuilder(Student.class).where(</span><br><span class=\"line\">                <span class=\"keyword\">new</span> WhereCondition.StringCondition(<span class=\"string\">&quot;_ID IN &quot;</span> +</span><br><span class=\"line\">                        <span class=\"string\">&quot;(SELECT _ID FROM STUDENT WHERE _ID &gt; 5)&quot;</span>)</span><br><span class=\"line\">        ).build();</span><br><span class=\"line\">        List&lt;Student&gt; list = query.list();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> list;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"嵌套条件查询\">嵌套条件查询<a title=\"#嵌套条件查询\" href=\"#嵌套条件查询\"></a></h4>\n<p>查询Id大于5小于10，且Name值为&quot;一&quot;的数据：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> List <span class=\"title\">queryList</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        DaoSession daoSession = ((AserbaoApplication) getApplication()).getDaoSession();</span><br><span class=\"line\">        QueryBuilder&lt;Student&gt; qb = daoSession.queryBuilder(Student.class);</span><br><span class=\"line\">        qb = daoSession.queryBuilder(Student.class);</span><br><span class=\"line\">        List&lt;Student&gt; list2 = qb.where(StudentDao.Properties.Name.eq(<span class=\"string\">&quot;一&quot;</span>),</span><br><span class=\"line\">                qb.and(StudentDao.Properties.Id.gt(<span class=\"number\">5</span>),</span><br><span class=\"line\">                        StudentDao.Properties.Id.le(<span class=\"number\">50</span>))).list();</span><br><span class=\"line\">        <span class=\"keyword\">return</span>  list2;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>取10条Id大于1的数据，且偏移2条</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> List <span class=\"title\">queryListByOther</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">       DaoSession daoSession = ((AserbaoApplication) getApplication()).getDaoSession();</span><br><span class=\"line\">       QueryBuilder&lt;Student&gt; qb = daoSession.queryBuilder(Student.class);</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"comment\">//搜索条件为Id值大于1，即结果为[2,3,4,5,6,7,8,9,10,11];</span></span><br><span class=\"line\">       <span class=\"comment\">// offset(2)表示往后偏移2个，结果为[4,5,6,7,8,9,10,11,12,13];</span></span><br><span class=\"line\">       List&lt;Student&gt; list = qb.where(StudentDao.Properties.Id.gt(<span class=\"number\">1</span>)).limit(<span class=\"number\">10</span>).offset(<span class=\"number\">2</span>).list();</span><br><span class=\"line\">       <span class=\"keyword\">return</span> list;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"多次执行查找\">多次执行查找<a title=\"#多次执行查找\" href=\"#多次执行查找\"></a></h4>\n<p>使用QueryBuilder构建查询后，可以重用 Query对象以便稍后执行查询。这比始终创建新的Query对象更有效。如果查询参数没有更改，您可以再次调用list / unique方法。可以通过setParameter方法来修改条件参数值：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"function\"><span class=\"keyword\">public</span> List <span class=\"title\">queryListByMoreTime</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        DaoSession daoSession = ((AserbaoApplication) getApplication()).getDaoSession();</span><br><span class=\"line\">        QueryBuilder&lt;Student&gt; qb = daoSession.queryBuilder(Student.class);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//搜索条件为Id值大于1，即结果为[2,3,4,5,6,7,8,9,10,11];</span></span><br><span class=\"line\">        <span class=\"comment\">// offset(2)表示往后偏移2个，结果为[4,5,6,7,8,9,10,11,12,13];</span></span><br><span class=\"line\">        Query&lt;Student&gt; query = qb.where(StudentDao.Properties.Id.gt(<span class=\"number\">1</span>)).limit(<span class=\"number\">10</span>).offset(<span class=\"number\">2</span>).build();</span><br><span class=\"line\">        List&lt;Student&gt; list = query.list();</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//通过SetParameter来修改上面的查询条件，比如我们将上面条件修改取10条Id值大于5，往后偏移两位的数据，方法如下！</span></span><br><span class=\"line\">        query.setParameter(<span class=\"number\">0</span>,<span class=\"number\">5</span>);</span><br><span class=\"line\">        List&lt;Student&gt; list1 = query.list();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> list1;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">```    </span><br><span class=\"line\"></span><br><span class=\"line\">#### 在多个线程中使用QueryBuilder</span><br><span class=\"line\">如果在多个线程中使用查询，则必须调用 forCurrentThread （）以获取当前线程的Query实例。Query的对象实例绑定到构建查询的拥有线程。</span><br><span class=\"line\">这使您可以安全地在Query对象上设置参数，而其他线程不会干扰。如果其他线程尝试在查询上设置参数或执行绑定到另一个线程的查询，则会抛出异常。像这样，您不需要同步语句。实际上，您应该避免锁定，因为如果并发事务使用相同的Query对象，这可能会导致死锁。</span><br><span class=\"line\">每次调用forCurrentThread （）时， 参数都会在使用其构建器构建查询时设置为初始参数。</span><br><span class=\"line\"></span><br><span class=\"line\">### 使用QueryBuilder进行批量删除操作</span><br><span class=\"line\">使用QueryBuilder进行批量删除操作，不会删除单个实体，但会删除符合某些条件的所有实体。要执行批量删除，请创建QueryBuilder，调用其 buildDelete （）方法，然后执行返回的 DeleteQuery。</span><br><span class=\"line\"></span><br><span class=\"line\">例子：删除数据库中id大于<span class=\"number\">5</span>的所有其他数据</span><br><span class=\"line\">```java</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">deleteItem</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        DaoSession daoSession = ((AserbaoApplication) getApplication()).getDaoSession();</span><br><span class=\"line\">        QueryBuilder&lt;Student&gt; where = daoSession.queryBuilder(Student.class).where(StudentDao.Properties.Id.gt(<span class=\"number\">5</span>));</span><br><span class=\"line\">        DeleteQuery&lt;Student&gt; deleteQuery = where.buildDelete();</span><br><span class=\"line\">        deleteQuery.executeDeleteWithoutDetachingEntities();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"注解讲解\">注解讲解<a title=\"#注解讲解\" href=\"#注解讲解\"></a></h2>\n<p>从GreenDao 3 使用注解来定义模型和实体，前面也讲过，通过注解的使用可以快速构建数据库表，包括设置主键，自增，值是否唯一等等等……</p>\n<p>下面我们来看下注解的简单使用：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Entity</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Student</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Id(autoincrement = true)</span></span><br><span class=\"line\">    Long id;</span><br><span class=\"line\">    <span class=\"meta\">@Unique</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> studentNo;<span class=\"comment\">//学号</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> age; <span class=\"comment\">//年龄</span></span><br><span class=\"line\">    String telPhone;<span class=\"comment\">//手机号</span></span><br><span class=\"line\">    String sex; <span class=\"comment\">//性别</span></span><br><span class=\"line\">    String name;<span class=\"comment\">//姓名</span></span><br><span class=\"line\">    String address;<span class=\"comment\">//家庭住址</span></span><br><span class=\"line\">    String schoolName;<span class=\"comment\">//学校名字</span></span><br><span class=\"line\">    String grade;<span class=\"comment\">//几年级</span></span><br><span class=\"line\">    ……getter and setter and constructor method……</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"@entity注解\">@Entity注解<a title=\"#@entity注解\" href=\"#@entity注解\"></a></h3>\n<p>@Entity是GreenDao必不可少的注解，只有在实体类中使用了@Entity注解GreenDao才会创建对应的表。当然我们也可以使用@Entity配置一些细节：</p>\n<ul>\n<li>schema：如果你有多个架构，你可以告诉GreenDao当前属于哪个架构。</li>\n<li>active：标记一个实体处于活跃状态，活动实体有更新、删除和刷新方法。</li>\n<li>nameInDb：在数据中使用的别名，默认使用的是实体的类名。</li>\n<li>indexes：标记如果DAO应该创建数据库表(默认为true)，如果您有多个实体映射到一个表，或者表的创建是在greenDAO之外进行的，那么将其设置为false。</li>\n<li>createInDb：标记创建数据库表。</li>\n<li>generateGettersSetters：如果缺少，是否应生成属性的getter和setter方法。</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Entity(</span></span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">        schema = &quot;myschema&quot;,</span></span><br><span class=\"line\"><span class=\"meta\">        active = true,</span></span><br><span class=\"line\"><span class=\"meta\">        nameInDb = &quot;AWESOME_USERS&quot;,</span></span><br><span class=\"line\"><span class=\"meta\">        indexes = &#123;</span></span><br><span class=\"line\"><span class=\"meta\">                @Index(value = &quot;message DESC&quot;, unique = true)</span></span><br><span class=\"line\"><span class=\"meta\">        &#125;,</span></span><br><span class=\"line\"><span class=\"meta\">        createInDb = false,</span></span><br><span class=\"line\"><span class=\"meta\">        generateConstructors = true,</span></span><br><span class=\"line\"><span class=\"meta\">        generateGettersSetters = true</span></span><br><span class=\"line\"><span class=\"meta\">)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Student</span></span>&#123;   </span><br><span class=\"line\">    ……</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"基础属性注解（@id，@property，@notnull，@transient）\">基础属性注解（@Id，@Property，@NotNull，@Transient）<a title=\"#基础属性注解（@id，@property，@notnull，@transient）\" href=\"#基础属性注解（@id，@property，@notnull，@transient）\"></a></h3>\n<p><strong>@Id</strong></p>\n<p>@Id注解选择 long / Long属性作为实体ID。在数据库方面，它是主键。参数autoincrement = true 表示自增，id不给赋值或者为赋值为null即可（这里需要注意，如果要实现自增，id必须是Long,为long不行！)。<br>\n@Entity<br>\npublic class Student {<br>\n@Id(autoincrement = true)<br>\nLong id;<br>\n……<br>\n}</p>\n<p><strong>@Property</strong></p>\n<p>允许您定义属性映射到的非默认列名。如果不存在，GreenDAO将以SQL-ish方式使用字段名称（大写，下划线而不是camel情况，例如 name将成为 NAME）。注意：您当前只能使用内联常量来指定列名。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Entity</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Student</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Id(autoincrement = true)</span></span><br><span class=\"line\">    Long id;</span><br><span class=\"line\">    <span class=\"meta\">@Property</span> (nameInDb=<span class=\"string\">&quot;name&quot;</span>) <span class=\"comment\">//设置了，数据库中的表格属性名为&quot;name&quot;,如果不设置，数据库中表格属性名为&quot;NAME&quot;</span></span><br><span class=\"line\">    String name;</span><br><span class=\"line\">    ……</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>@NotNull</strong> ：设置数据库表当前列不能为空 。</p>\n<p><strong>@Transient</strong> ：添加次标记之后不会生成数据库表的列。标记要从持久性中排除的属性。将它们用于临时状态等。或者，您也可以使用Java中的transient关键字。</p>\n<h3 id=\"索引注解\">索引注解<a title=\"#索引注解\" href=\"#索引注解\"></a></h3>\n<p><strong>@Index</strong>：使用@Index作为一个属性来创建一个索引，通过name设置索引别名，也可以通过unique给索引添加约束。</p>\n<p><strong>@Unique</strong>：向索引添加UNIQUE约束，强制所有值都是唯一的。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Entity</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Student</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Id(autoincrement = true)</span></span><br><span class=\"line\">    Long id;</span><br><span class=\"line\">    <span class=\"meta\">@Property(nameInDb=&quot;name&quot;)</span></span><br><span class=\"line\">    <span class=\"meta\">@Index(unique = true)</span></span><br><span class=\"line\">     String name;</span><br><span class=\"line\">    ……</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>注意： 上面这种情况，约定name为唯一值，向数据库中通过insert方法继续添加已存在的name数据，会抛异常：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">10</span>-08 <span class=\"number\">20</span>:<span class=\"number\">59</span>:<span class=\"number\">46.274</span> <span class=\"number\">31939</span>-<span class=\"number\">31939</span>/com.example.aserbao.aserbaosandroid E/AndroidRuntime: FATAL EXCEPTION: main</span><br><span class=\"line\">    Process: com.example.aserbao.aserbaosandroid, PID: <span class=\"number\">31939</span></span><br><span class=\"line\">    android.database.sqlite.SQLiteConstraintException: UNIQUE constraint failed: STUDENT.name (Sqlite code <span class=\"number\">2067</span>), (OS error - <span class=\"number\">2</span>:No such file or directory)</span><br><span class=\"line\">    ……</span><br></pre></td></tr></table></figure>\n<p>若使用insertOrReplace()方法添加数据，当前数据库中不会有重复的数据，但是重复的这条数据的id会被修改！若项目中有用到id字段进行排序的话，这一点需要特别注意。</p>\n<h3 id=\"关系注解\">关系注解<a title=\"#关系注解\" href=\"#关系注解\"></a></h3>\n<p>关系型注解GreenDao中主要就两个：</p>\n<ul>\n<li><strong>@ToOne</strong>：定义与另一个实体（一个实体对象）的关系</li>\n<li><strong>@ToMany</strong>：定义与多个实体对象的关系<br>\n至于如何使用，我们马上就讲。</li>\n</ul>\n<h2 id=\"一对一，一对多，多对多关系表的创建\">一对一，一对多，多对多关系表的创建<a title=\"#一对一，一对多，多对多关系表的创建\" href=\"#一对一，一对多，多对多关系表的创建\"></a></h2>\n<p>平常项目中，我们经常会使用到多表关联，如文章开头所说的数据库表结构设置的那样！接下来我们来讲如何通过GreenDao实现多表关联。</p>\n<h3 id=\"一对一\">一对一<a title=\"#一对一\" href=\"#一对一\"></a></h3>\n<p>一个学生对应一个身份证号:</p>\n<p>做法：</p>\n<ul>\n<li>我们在Student中设置一个注解@ToOne(joinProperty = “name”)</li>\n<li>在创建Student的时候，将对应的数据传递给IdCard;</li>\n</ul>\n<p>代码部分：</p>\n<p>学生Student代码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Entity</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Student</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Id(autoincrement = true)</span></span><br><span class=\"line\">    Long id;</span><br><span class=\"line\">    <span class=\"meta\">@Unique</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> studentNo;<span class=\"comment\">//学号</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> age; <span class=\"comment\">//年龄</span></span><br><span class=\"line\">    String telPhone;<span class=\"comment\">//手机号</span></span><br><span class=\"line\">    String sex; <span class=\"comment\">//性别</span></span><br><span class=\"line\">    String name;<span class=\"comment\">//姓名</span></span><br><span class=\"line\">    String address;<span class=\"comment\">//家庭住址</span></span><br><span class=\"line\">    String schoolName;<span class=\"comment\">//学校名字</span></span><br><span class=\"line\">    String grade;<span class=\"comment\">//几年级</span></span><br><span class=\"line\">    <span class=\"meta\">@ToOne(joinProperty = &quot;name&quot;)</span></span><br><span class=\"line\">    IdCard student;</span><br><span class=\"line\">    ……getter and setter ……</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>身份证IdCard代码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Entity</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">IdCard</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Id</span> </span><br><span class=\"line\">    String userName;<span class=\"comment\">//用户名</span></span><br><span class=\"line\">    <span class=\"meta\">@Unique</span></span><br><span class=\"line\">    String idNo;<span class=\"comment\">//身份证号</span></span><br><span class=\"line\">       ……getter and setter ……</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>insert一组数据：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">addStudent</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    DaoSession daoSession = ((AserbaoApplication) getApplication()).getDaoSession();</span><br><span class=\"line\">    Student student = <span class=\"keyword\">new</span> Student();</span><br><span class=\"line\">    student.setStudentNo(i);</span><br><span class=\"line\">    <span class=\"keyword\">int</span> age = mRandom.nextInt(<span class=\"number\">10</span>) + <span class=\"number\">10</span>;</span><br><span class=\"line\">    student.setAge(age);</span><br><span class=\"line\">    student.setTelPhone(RandomValue.getTel());</span><br><span class=\"line\">    String chineseName = RandomValue.getChineseName();</span><br><span class=\"line\">    student.setName(chineseName);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (i % <span class=\"number\">2</span> == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        student.setSex(<span class=\"string\">&quot;男&quot;</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        student.setSex(<span class=\"string\">&quot;女&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    student.setAddress(RandomValue.getRoad());</span><br><span class=\"line\">    student.setGrade(String.valueOf(age % <span class=\"number\">10</span>) + <span class=\"string\">&quot;年纪&quot;</span>);</span><br><span class=\"line\">    student.setSchoolName(RandomValue.getSchoolName());</span><br><span class=\"line\">    daoSession.insert(student);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//插入对应的IdCard数据</span></span><br><span class=\"line\">    IdCard idCard = <span class=\"keyword\">new</span> IdCard();</span><br><span class=\"line\">    idCard.setUserName(userName);</span><br><span class=\"line\">    idCard.setIdNo(RandomValue.getRandomID());</span><br><span class=\"line\">    daoSession.insert(idCard);</span><br><span class=\"line\">      &#125;</span><br></pre></td></tr></table></figure>\n<p>ok,数据可以了！现在数据库表插入完成了。</p>\n<h3 id=\"一对多\">一对多<a title=\"#一对多\" href=\"#一对多\"></a></h3>\n<p>一个人拥有多个信用卡</p>\n<p>做法：</p>\n<ul>\n<li>在我们在Student中设置@ToMany(referencedJoinProperty = “studentId”);</li>\n<li>我们在CreditCard中设置编写对应的id主键；</li>\n</ul>\n<p>Student的代码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Entity</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Student</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Id(autoincrement = true)</span></span><br><span class=\"line\">    Long id;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Unique</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> studentNo;<span class=\"comment\">//学号</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">int</span> age; <span class=\"comment\">//年龄</span></span><br><span class=\"line\">    String telPhone;<span class=\"comment\">//手机号</span></span><br><span class=\"line\">    String sex; <span class=\"comment\">//性别</span></span><br><span class=\"line\">    String name;<span class=\"comment\">//姓名</span></span><br><span class=\"line\">    String address;<span class=\"comment\">//家庭住址</span></span><br><span class=\"line\">    String schoolName;<span class=\"comment\">//学校名字</span></span><br><span class=\"line\">    String grade;<span class=\"comment\">//几年级</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"meta\">@ToMany(referencedJoinProperty = &quot;studentId)</span> <span class=\"comment\">// 这个studentId是对应在CreditCard中的studentId</span></span><br><span class=\"line\">    List&lt;CreditCard&gt; creditCardsList;</span><br><span class=\"line\">      ……getter and setter ……</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>CreditCard的代码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Entity</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CreditCard</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Id</span></span><br><span class=\"line\">    Long id;</span><br><span class=\"line\">    Long studentId;</span><br><span class=\"line\">    Long teacherId;</span><br><span class=\"line\">    String userName;<span class=\"comment\">//持有者名字</span></span><br><span class=\"line\">    String cardNum;<span class=\"comment\">//卡号</span></span><br><span class=\"line\">    String whichBank;<span class=\"comment\">//哪个银行的</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> cardType;<span class=\"comment\">//卡等级，分类 0 ~ 5</span></span><br><span class=\"line\">     ……getter and setter ……</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">```    </span><br><span class=\"line\"></span><br><span class=\"line\">添加数据代码：</span><br><span class=\"line\">```java</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">addStudent</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    DaoSession daoSession = ((AserbaoApplication) getApplication()).getDaoSession();</span><br><span class=\"line\">    Student student = <span class=\"keyword\">new</span> Student();</span><br><span class=\"line\">    student.setStudentNo(i);</span><br><span class=\"line\">    <span class=\"keyword\">int</span> age = mRandom.nextInt(<span class=\"number\">10</span>) + <span class=\"number\">10</span>;</span><br><span class=\"line\">    student.setAge(age);</span><br><span class=\"line\">    student.setTelPhone(RandomValue.getTel());</span><br><span class=\"line\">    String chineseName = RandomValue.getChineseName();</span><br><span class=\"line\">    student.setName(chineseName);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (i % <span class=\"number\">2</span> == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        student.setSex(<span class=\"string\">&quot;男&quot;</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        student.setSex(<span class=\"string\">&quot;女&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    student.setAddress(RandomValue.getRoad());</span><br><span class=\"line\">    student.setGrade(String.valueOf(age % <span class=\"number\">10</span>) + <span class=\"string\">&quot;年纪&quot;</span>);</span><br><span class=\"line\">    student.setSchoolName(RandomValue.getSchoolName());</span><br><span class=\"line\">    daoSession.insert(student);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//插入对应的CreditCard数据</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> j = <span class=\"number\">0</span>; j &lt; random.nextInt(<span class=\"number\">5</span>) + <span class=\"number\">1</span> ; j++) &#123;</span><br><span class=\"line\">    CreditCard creditCard = <span class=\"keyword\">new</span> CreditCard();</span><br><span class=\"line\">    creditCard.setUserId(id);</span><br><span class=\"line\">    creditCard.setUserName(userName);</span><br><span class=\"line\">    creditCard.setCardNum(String.valueOf(random.nextInt(<span class=\"number\">899999999</span>) + <span class=\"number\">100000000</span>) + String.valueOf(random.nextInt(<span class=\"number\">899999999</span>) + <span class=\"number\">100000000</span>));</span><br><span class=\"line\">    creditCard.setWhichBank(RandomValue.getBankName());</span><br><span class=\"line\">    creditCard.setCardType(random.nextInt(<span class=\"number\">10</span>));</span><br><span class=\"line\">    daoSession.insert(creditCard);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">```      </span><br><span class=\"line\"></span><br><span class=\"line\">### 多对多</span><br><span class=\"line\">一个学生有多个老师，老师有多个学生。</span><br><span class=\"line\"></span><br><span class=\"line\">做法：</span><br><span class=\"line\"></span><br><span class=\"line\">我们需要创建一个学生老师管理器(StudentAndTeacherBean)，用来对应学生和老师的ID;</span><br><span class=\"line\"></span><br><span class=\"line\">我们需要在学生对象中，添加注解：</span><br><span class=\"line\">```java</span><br><span class=\"line\"><span class=\"meta\">@ToMany</span></span><br><span class=\"line\"><span class=\"meta\">@JoinEntity(entity = StudentAndTeacherBean.class,sourceProperty = &quot;studentId&quot;,targetProperty = &quot;teacherId&quot;)</span></span><br><span class=\"line\">List&lt;Teacher&gt; teacherList;</span><br></pre></td></tr></table></figure>\n<p>我们需要在老师对象中，添加注解：@ToMany</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@JoinEntity(entity = StudentAndTeacherBean.class,sourceProperty = &quot;teacherId&quot;,targetProperty = &quot;studentId&quot;)</span></span><br><span class=\"line\">  List&lt;Student&gt; studentList;</span><br></pre></td></tr></table></figure>\n<p>StudentAndTeacherBean代码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Entity</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">StudentAndTeacherBean</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Id(autoincrement = true)</span></span><br><span class=\"line\">    Long id;</span><br><span class=\"line\">    Long studentId;<span class=\"comment\">//学生ID</span></span><br><span class=\"line\">    Long teacherId;<span class=\"comment\">//老师ID</span></span><br><span class=\"line\">    ……getter and setter ……</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Student 代码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Entity</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Student</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Id(autoincrement = true)</span></span><br><span class=\"line\">    Long id;</span><br><span class=\"line\">    <span class=\"meta\">@Unique</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> studentNo;<span class=\"comment\">//学号</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> age; <span class=\"comment\">//年龄</span></span><br><span class=\"line\">    String telPhone;<span class=\"comment\">//手机号</span></span><br><span class=\"line\">    String sex; <span class=\"comment\">//性别</span></span><br><span class=\"line\">    String name;<span class=\"comment\">//姓名</span></span><br><span class=\"line\">    String address;<span class=\"comment\">//家庭住址</span></span><br><span class=\"line\">    String schoolName;<span class=\"comment\">//学校名字</span></span><br><span class=\"line\">    String grade;<span class=\"comment\">//几年级</span></span><br><span class=\"line\">    <span class=\"meta\">@ToMany</span></span><br><span class=\"line\">    <span class=\"meta\">@JoinEntity(entity = StudentAndTeacherBean.class,sourceProperty = &quot;studentId&quot;,targetProperty = &quot;teacherId&quot;)</span></span><br><span class=\"line\">    List&lt;Teacher&gt; teacherList;</span><br><span class=\"line\">        ……getter and setter ……</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>Teacher代码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Entity</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Teacher</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Id(autoincrement = true)</span></span><br><span class=\"line\">    Long id;</span><br><span class=\"line\">    <span class=\"meta\">@Unique</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> teacherNo;<span class=\"comment\">//职工号</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> age; <span class=\"comment\">//年龄</span></span><br><span class=\"line\">    String sex; <span class=\"comment\">//性别</span></span><br><span class=\"line\">    String telPhone;</span><br><span class=\"line\">    String name;<span class=\"comment\">//姓名</span></span><br><span class=\"line\">    String schoolName;<span class=\"comment\">//学校名字</span></span><br><span class=\"line\">    String subject;<span class=\"comment\">//科目</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@ToMany</span></span><br><span class=\"line\">    <span class=\"meta\">@JoinEntity(entity = StudentAndTeacherBean.class,sourceProperty = &quot;teacherId&quot;,targetProperty = &quot;studentId&quot;)</span></span><br><span class=\"line\">    List&lt;Student&gt; studentList;</span><br><span class=\"line\">  ……getter and setter ……</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>数据添加：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">addData</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    Student student = <span class=\"keyword\">new</span> Student();</span><br><span class=\"line\">    student.setStudentNo(i);</span><br><span class=\"line\">    <span class=\"keyword\">int</span> age = mRandom.nextInt(<span class=\"number\">10</span>) + <span class=\"number\">10</span>;</span><br><span class=\"line\">    student.setAge(age);</span><br><span class=\"line\">    student.setTelPhone(RandomValue.getTel());</span><br><span class=\"line\">    String chineseName = RandomValue.getChineseName();</span><br><span class=\"line\">    student.setName(chineseName);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (i % <span class=\"number\">2</span> == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        student.setSex(<span class=\"string\">&quot;男&quot;</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        student.setSex(<span class=\"string\">&quot;女&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    student.setAddress(RandomValue.getRoad());</span><br><span class=\"line\">    student.setGrade(String.valueOf(age % <span class=\"number\">10</span>) + <span class=\"string\">&quot;年纪&quot;</span>);</span><br><span class=\"line\">    student.setSchoolName(RandomValue.getSchoolName());</span><br><span class=\"line\">    daoSession.insert(student);</span><br><span class=\"line\"></span><br><span class=\"line\">    Collections.shuffle(teacherList);</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> j = <span class=\"number\">0</span>; j &lt; mRandom.nextInt(<span class=\"number\">8</span>) + <span class=\"number\">1</span>; j++) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(j &lt; teacherList.size())&#123;</span><br><span class=\"line\">            Teacher teacher = teacherList.get(j);</span><br><span class=\"line\">            StudentAndTeacherBean teacherBean = <span class=\"keyword\">new</span> StudentAndTeacherBean(student.getId(), teacher.getId());</span><br><span class=\"line\">            daoSession.insert(teacherBean);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">```                        </span><br><span class=\"line\"></span><br><span class=\"line\">好了，成功;</span><br><span class=\"line\"></span><br><span class=\"line\">## 数据库的升级</span><br><span class=\"line\">GreenDao的OpenHelper下有个 onUpgrade(Database db, <span class=\"keyword\">int</span> oldVersion, <span class=\"keyword\">int</span> newVersion)方法，当设置的数据库版本改变时，在数据库初始化的时候就会回调到这个方法，我们可以通过继承OpenHelper重写onUpgrade方法来实现数据库更新操作：</span><br><span class=\"line\"></span><br><span class=\"line\">GreenDao的升级思路：</span><br><span class=\"line\"></span><br><span class=\"line\">- 创建临时表TMP_,复制原来的数据库到临时表中；</span><br><span class=\"line\">- 删除之前的原表；</span><br><span class=\"line\">- 创建新表；</span><br><span class=\"line\">- 将临时表中的数据复制到新表中，最后将TMP_表删除掉；</span><br><span class=\"line\"></span><br><span class=\"line\">ok,思路就是这样， 总共两个类： 一个MyDaoMaster(OpenHelper继承类)，一个MigrationHelper(数据库操作类) 下面是代码编写：</span><br><span class=\"line\"></span><br><span class=\"line\">修改Application中的DaoMaster的创建：</span><br><span class=\"line\">```java</span><br><span class=\"line\">        MyDaoMaster helper = <span class=\"keyword\">new</span> MyDaoMaster(<span class=\"keyword\">this</span>, <span class=\"string\">&quot;aserbaos.db&quot;</span>);</span><br><span class=\"line\"><span class=\"comment\">//      DaoMaster.DevOpenHelper helper = new DaoMaster.DevOpenHelper(this, &quot;aserbao.db&quot;);</span></span><br><span class=\"line\">        SQLiteDatabase db = helper.getWritableDatabase();</span><br><span class=\"line\">        DaoMaster daoMaster = <span class=\"keyword\">new</span> DaoMaster(db);</span><br><span class=\"line\">        daoSession = daoMaster.newSession();</span><br></pre></td></tr></table></figure>\n<p>MyDaoMaster代码:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyDaoMaster</span> <span class=\"keyword\">extends</span> <span class=\"title\">OpenHelper</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TAG = <span class=\"string\">&quot;MyDaoMaster&quot;</span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">MyDaoMaster</span><span class=\"params\">(Context context, String name)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>(context, name);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">MyDaoMaster</span><span class=\"params\">(Context context, String name, SQLiteDatabase.CursorFactory factory)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>(context, name, factory);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onUpgrade</span><span class=\"params\">(Database db, <span class=\"keyword\">int</span> oldVersion, <span class=\"keyword\">int</span> newVersion)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>.onUpgrade(db, oldVersion, newVersion);</span><br><span class=\"line\">        MigrationHelper.migrate(db, <span class=\"keyword\">new</span> MigrationHelper.ReCreateAllTableListener() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onCreateAllTables</span><span class=\"params\">(Database db, <span class=\"keyword\">boolean</span> ifNotExists)</span> </span>&#123;</span><br><span class=\"line\">                DaoMaster.createAllTables(db, ifNotExists);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onDropAllTables</span><span class=\"params\">(Database db, <span class=\"keyword\">boolean</span> ifExists)</span> </span>&#123;</span><br><span class=\"line\">                DaoMaster.dropAllTables(db, ifExists);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;,ThingDao.class);</span><br><span class=\"line\">        Log.e(TAG, <span class=\"string\">&quot;onUpgrade: &quot;</span> + oldVersion + <span class=\"string\">&quot; newVersion = &quot;</span> + newVersion);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>MigrationHelper 代码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MigrationHelper</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">boolean</span> DEBUG = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> String TAG = <span class=\"string\">&quot;MigrationHelper&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String SQLITE_MASTER = <span class=\"string\">&quot;sqlite_master&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String SQLITE_TEMP_MASTER = <span class=\"string\">&quot;sqlite_temp_master&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> WeakReference&lt;ReCreateAllTableListener&gt; weakListener;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">ReCreateAllTableListener</span></span>&#123;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onCreateAllTables</span><span class=\"params\">(Database db, <span class=\"keyword\">boolean</span> ifNotExists)</span></span>;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onDropAllTables</span><span class=\"params\">(Database db, <span class=\"keyword\">boolean</span> ifExists)</span></span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">migrate</span><span class=\"params\">(SQLiteDatabase db, Class&lt;? extends AbstractDao&lt;?, ?&gt;&gt;... daoClasses)</span> </span>&#123;</span><br><span class=\"line\">        printLog(<span class=\"string\">&quot;【The Old Database Version】&quot;</span> + db.getVersion());</span><br><span class=\"line\">        Database database = <span class=\"keyword\">new</span> StandardDatabase(db);</span><br><span class=\"line\">        migrate(database, daoClasses);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">migrate</span><span class=\"params\">(SQLiteDatabase db, ReCreateAllTableListener listener, Class&lt;? extends AbstractDao&lt;?, ?&gt;&gt;... daoClasses)</span> </span>&#123;</span><br><span class=\"line\">        weakListener = <span class=\"keyword\">new</span> WeakReference&lt;&gt;(listener);</span><br><span class=\"line\">        migrate(db, daoClasses);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">migrate</span><span class=\"params\">(Database database, ReCreateAllTableListener listener, Class&lt;? extends AbstractDao&lt;?, ?&gt;&gt;... daoClasses)</span> </span>&#123;</span><br><span class=\"line\">        weakListener = <span class=\"keyword\">new</span> WeakReference&lt;&gt;(listener);</span><br><span class=\"line\">        migrate(database, daoClasses);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">migrate</span><span class=\"params\">(Database database, Class&lt;? extends AbstractDao&lt;?, ?&gt;&gt;... daoClasses)</span> </span>&#123;</span><br><span class=\"line\">        printLog(<span class=\"string\">&quot;【Generate temp table】start&quot;</span>);</span><br><span class=\"line\">        generateTempTables(database, daoClasses);</span><br><span class=\"line\">        printLog(<span class=\"string\">&quot;【Generate temp table】complete&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        ReCreateAllTableListener listener = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (weakListener != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            listener = weakListener.get();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (listener != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            listener.onDropAllTables(database, <span class=\"keyword\">true</span>);</span><br><span class=\"line\">            printLog(<span class=\"string\">&quot;【Drop all table by listener】&quot;</span>);</span><br><span class=\"line\">            listener.onCreateAllTables(database, <span class=\"keyword\">false</span>);</span><br><span class=\"line\">            printLog(<span class=\"string\">&quot;【Create all table by listener】&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            dropAllTables(database, <span class=\"keyword\">true</span>, daoClasses);</span><br><span class=\"line\">            createAllTables(database, <span class=\"keyword\">false</span>, daoClasses);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        printLog(<span class=\"string\">&quot;【Restore data】start&quot;</span>);</span><br><span class=\"line\">        restoreData(database, daoClasses);</span><br><span class=\"line\">        printLog(<span class=\"string\">&quot;【Restore data】complete&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">generateTempTables</span><span class=\"params\">(Database db, Class&lt;? extends AbstractDao&lt;?, ?&gt;&gt;... daoClasses)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; daoClasses.length; i++) &#123;</span><br><span class=\"line\">            String tempTableName = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">            DaoConfig daoConfig = <span class=\"keyword\">new</span> DaoConfig(db, daoClasses[i]);</span><br><span class=\"line\">            String tableName = daoConfig.tablename;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!isTableExists(db, <span class=\"keyword\">false</span>, tableName)) &#123;</span><br><span class=\"line\">                printLog(<span class=\"string\">&quot;【New Table】&quot;</span> + tableName);</span><br><span class=\"line\">                <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                tempTableName = daoConfig.tablename.concat(<span class=\"string\">&quot;_TEMP&quot;</span>);</span><br><span class=\"line\">                StringBuilder dropTableStringBuilder = <span class=\"keyword\">new</span> StringBuilder();</span><br><span class=\"line\">                dropTableStringBuilder.append(<span class=\"string\">&quot;DROP TABLE IF EXISTS &quot;</span>).append(tempTableName).append(<span class=\"string\">&quot;;&quot;</span>);</span><br><span class=\"line\">                db.execSQL(dropTableStringBuilder.toString());</span><br><span class=\"line\"></span><br><span class=\"line\">                StringBuilder insertTableStringBuilder = <span class=\"keyword\">new</span> StringBuilder();</span><br><span class=\"line\">                insertTableStringBuilder.append(<span class=\"string\">&quot;CREATE TEMPORARY TABLE &quot;</span>).append(tempTableName);</span><br><span class=\"line\">                insertTableStringBuilder.append(<span class=\"string\">&quot; AS SELECT * FROM &quot;</span>).append(tableName).append(<span class=\"string\">&quot;;&quot;</span>);</span><br><span class=\"line\">                db.execSQL(insertTableStringBuilder.toString());</span><br><span class=\"line\">                printLog(<span class=\"string\">&quot;【Table】&quot;</span> + tableName +<span class=\"string\">&quot;\\n ---Columns--&gt;&quot;</span>+getColumnsStr(daoConfig));</span><br><span class=\"line\">                printLog(<span class=\"string\">&quot;【Generate temp table】&quot;</span> + tempTableName);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (SQLException e) &#123;</span><br><span class=\"line\">                Log.e(TAG, <span class=\"string\">&quot;【Failed to generate temp table】&quot;</span> + tempTableName, e);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isTableExists</span><span class=\"params\">(Database db, <span class=\"keyword\">boolean</span> isTemp, String tableName)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (db == <span class=\"keyword\">null</span> || TextUtils.isEmpty(tableName)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        String dbName = isTemp ? SQLITE_TEMP_MASTER : SQLITE_MASTER;</span><br><span class=\"line\">        String sql = <span class=\"string\">&quot;SELECT COUNT(*) FROM &quot;</span> + dbName + <span class=\"string\">&quot; WHERE type = ? AND name = ?&quot;</span>;</span><br><span class=\"line\">        Cursor cursor=<span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> count = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            cursor = db.rawQuery(sql, <span class=\"keyword\">new</span> String[]&#123;<span class=\"string\">&quot;table&quot;</span>, tableName&#125;);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (cursor == <span class=\"keyword\">null</span> || !cursor.moveToFirst()) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            count = cursor.getInt(<span class=\"number\">0</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (cursor != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">                cursor.close();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> count &gt; <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> String <span class=\"title\">getColumnsStr</span><span class=\"params\">(DaoConfig daoConfig)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (daoConfig == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"string\">&quot;no columns&quot;</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        StringBuilder builder = <span class=\"keyword\">new</span> StringBuilder();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; daoConfig.allColumns.length; i++) &#123;</span><br><span class=\"line\">            builder.append(daoConfig.allColumns[i]);</span><br><span class=\"line\">            builder.append(<span class=\"string\">&quot;,&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (builder.length() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            builder.deleteCharAt(builder.length() - <span class=\"number\">1</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> builder.toString();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">dropAllTables</span><span class=\"params\">(Database db, <span class=\"keyword\">boolean</span> ifExists, <span class=\"meta\">@NonNull</span> Class&lt;? extends AbstractDao&lt;?, ?&gt;&gt;... daoClasses)</span> </span>&#123;</span><br><span class=\"line\">        reflectMethod(db, <span class=\"string\">&quot;dropTable&quot;</span>, ifExists, daoClasses);</span><br><span class=\"line\">        printLog(<span class=\"string\">&quot;【Drop all table by reflect】&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">createAllTables</span><span class=\"params\">(Database db, <span class=\"keyword\">boolean</span> ifNotExists, <span class=\"meta\">@NonNull</span> Class&lt;? extends AbstractDao&lt;?, ?&gt;&gt;... daoClasses)</span> </span>&#123;</span><br><span class=\"line\">        reflectMethod(db, <span class=\"string\">&quot;createTable&quot;</span>, ifNotExists, daoClasses);</span><br><span class=\"line\">        printLog(<span class=\"string\">&quot;【Create all table by reflect】&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * dao class already define the sql exec method, so just invoke it</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">reflectMethod</span><span class=\"params\">(Database db, String methodName, <span class=\"keyword\">boolean</span> isExists, <span class=\"meta\">@NonNull</span> Class&lt;? extends AbstractDao&lt;?, ?&gt;&gt;... daoClasses)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (daoClasses.length &lt; <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (Class cls : daoClasses) &#123;</span><br><span class=\"line\">                Method method = cls.getDeclaredMethod(methodName, Database.class, <span class=\"keyword\">boolean</span>.class);</span><br><span class=\"line\">                method.invoke(<span class=\"keyword\">null</span>, db, isExists);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (NoSuchMethodException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (InvocationTargetException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (IllegalAccessException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">restoreData</span><span class=\"params\">(Database db, Class&lt;? extends AbstractDao&lt;?, ?&gt;&gt;... daoClasses)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; daoClasses.length; i++) &#123;</span><br><span class=\"line\">            DaoConfig daoConfig = <span class=\"keyword\">new</span> DaoConfig(db, daoClasses[i]);</span><br><span class=\"line\">            String tableName = daoConfig.tablename;</span><br><span class=\"line\">            String tempTableName = daoConfig.tablename.concat(<span class=\"string\">&quot;_TEMP&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!isTableExists(db, <span class=\"keyword\">true</span>, tempTableName)) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">// get all columns from tempTable, take careful to use the columns list</span></span><br><span class=\"line\">                List&lt;TableInfo&gt; newTableInfos = TableInfo.getTableInfo(db, tableName);</span><br><span class=\"line\">                List&lt;TableInfo&gt; tempTableInfos = TableInfo.getTableInfo(db, tempTableName);</span><br><span class=\"line\">                ArrayList&lt;String&gt; selectColumns = <span class=\"keyword\">new</span> ArrayList&lt;&gt;(newTableInfos.size());</span><br><span class=\"line\">                ArrayList&lt;String&gt; intoColumns = <span class=\"keyword\">new</span> ArrayList&lt;&gt;(newTableInfos.size());</span><br><span class=\"line\">                <span class=\"keyword\">for</span> (TableInfo tableInfo : tempTableInfos) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (newTableInfos.contains(tableInfo)) &#123;</span><br><span class=\"line\">                        String column = <span class=\"string\">&#x27;`&#x27;</span> + tableInfo.name + <span class=\"string\">&#x27;`&#x27;</span>;</span><br><span class=\"line\">                        intoColumns.add(column);</span><br><span class=\"line\">                        selectColumns.add(column);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"comment\">// NOT NULL columns list</span></span><br><span class=\"line\">                <span class=\"keyword\">for</span> (TableInfo tableInfo : newTableInfos) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (tableInfo.notnull &amp;&amp; !tempTableInfos.contains(tableInfo)) &#123;</span><br><span class=\"line\">                        String column = <span class=\"string\">&#x27;`&#x27;</span> + tableInfo.name + <span class=\"string\">&#x27;`&#x27;</span>;</span><br><span class=\"line\">                        intoColumns.add(column);</span><br><span class=\"line\"></span><br><span class=\"line\">                        String value;</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (tableInfo.dfltValue != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                            value = <span class=\"string\">&quot;&#x27;&quot;</span> + tableInfo.dfltValue + <span class=\"string\">&quot;&#x27; AS &quot;</span>;</span><br><span class=\"line\">                        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                            value = <span class=\"string\">&quot;&#x27;&#x27; AS &quot;</span>;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                        selectColumns.add(value + column);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (intoColumns.size() != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                    StringBuilder insertTableStringBuilder = <span class=\"keyword\">new</span> StringBuilder();</span><br><span class=\"line\">                    insertTableStringBuilder.append(<span class=\"string\">&quot;REPLACE INTO &quot;</span>).append(tableName).append(<span class=\"string\">&quot; (&quot;</span>);</span><br><span class=\"line\">                    insertTableStringBuilder.append(TextUtils.join(<span class=\"string\">&quot;,&quot;</span>, intoColumns));</span><br><span class=\"line\">                    insertTableStringBuilder.append(<span class=\"string\">&quot;) SELECT &quot;</span>);</span><br><span class=\"line\">                    insertTableStringBuilder.append(TextUtils.join(<span class=\"string\">&quot;,&quot;</span>, selectColumns));</span><br><span class=\"line\">                    insertTableStringBuilder.append(<span class=\"string\">&quot; FROM &quot;</span>).append(tempTableName).append(<span class=\"string\">&quot;;&quot;</span>);</span><br><span class=\"line\">                    db.execSQL(insertTableStringBuilder.toString());</span><br><span class=\"line\">                    printLog(<span class=\"string\">&quot;【Restore data】 to &quot;</span> + tableName);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                StringBuilder dropTableStringBuilder = <span class=\"keyword\">new</span> StringBuilder();</span><br><span class=\"line\">                dropTableStringBuilder.append(<span class=\"string\">&quot;DROP TABLE &quot;</span>).append(tempTableName);</span><br><span class=\"line\">                db.execSQL(dropTableStringBuilder.toString());</span><br><span class=\"line\">                printLog(<span class=\"string\">&quot;【Drop temp table】&quot;</span> + tempTableName);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (SQLException e) &#123;</span><br><span class=\"line\">                Log.e(TAG, <span class=\"string\">&quot;【Failed to restore data from temp table 】&quot;</span> + tempTableName, e);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> List&lt;String&gt; <span class=\"title\">getColumns</span><span class=\"params\">(Database db, String tableName)</span> </span>&#123;</span><br><span class=\"line\">        List&lt;String&gt; columns = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        Cursor cursor = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            cursor = db.rawQuery(<span class=\"string\">&quot;SELECT * FROM &quot;</span> + tableName + <span class=\"string\">&quot; limit 0&quot;</span>, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> != cursor &amp;&amp; cursor.getColumnCount() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                columns = Arrays.asList(cursor.getColumnNames());</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (cursor != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">                cursor.close();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == columns)</span><br><span class=\"line\">                columns = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> columns;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">printLog</span><span class=\"params\">(String info)</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(DEBUG)&#123;</span><br><span class=\"line\">            Log.d(TAG, info);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TableInfo</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> cid;</span><br><span class=\"line\">        String name;</span><br><span class=\"line\">        String type;</span><br><span class=\"line\">        <span class=\"keyword\">boolean</span> notnull;</span><br><span class=\"line\">        String dfltValue;</span><br><span class=\"line\">        <span class=\"keyword\">boolean</span> pk;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">equals</span><span class=\"params\">(Object o)</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">this</span> == o</span><br><span class=\"line\">                    || o != <span class=\"keyword\">null</span></span><br><span class=\"line\">                    &amp;&amp; getClass() == o.getClass()</span><br><span class=\"line\">                    &amp;&amp; name.equals(((TableInfo) o).name);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">toString</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"string\">&quot;TableInfo&#123;&quot;</span> +</span><br><span class=\"line\">                    <span class=\"string\">&quot;cid=&quot;</span> + cid +</span><br><span class=\"line\">                    <span class=\"string\">&quot;, name=&#x27;&quot;</span> + name + <span class=\"string\">&#x27;\\&#x27;&#x27;</span> +</span><br><span class=\"line\">                    <span class=\"string\">&quot;, type=&#x27;&quot;</span> + type + <span class=\"string\">&#x27;\\&#x27;&#x27;</span> +</span><br><span class=\"line\">                    <span class=\"string\">&quot;, notnull=&quot;</span> + notnull +</span><br><span class=\"line\">                    <span class=\"string\">&quot;, dfltValue=&#x27;&quot;</span> + dfltValue + <span class=\"string\">&#x27;\\&#x27;&#x27;</span> +</span><br><span class=\"line\">                    <span class=\"string\">&quot;, pk=&quot;</span> + pk +</span><br><span class=\"line\">                    <span class=\"string\">&#x27;&#125;&#x27;</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> List&lt;TableInfo&gt; <span class=\"title\">getTableInfo</span><span class=\"params\">(Database db, String tableName)</span> </span>&#123;</span><br><span class=\"line\">            String sql = <span class=\"string\">&quot;PRAGMA table_info(&quot;</span> + tableName + <span class=\"string\">&quot;)&quot;</span>;</span><br><span class=\"line\">            printLog(sql);</span><br><span class=\"line\">            Cursor cursor = db.rawQuery(sql, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (cursor == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</span><br><span class=\"line\">            TableInfo tableInfo;</span><br><span class=\"line\">            List&lt;TableInfo&gt; tableInfos = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</span><br><span class=\"line\">            <span class=\"keyword\">while</span> (cursor.moveToNext()) &#123;</span><br><span class=\"line\">                tableInfo = <span class=\"keyword\">new</span> TableInfo();</span><br><span class=\"line\">                tableInfo.cid = cursor.getInt(<span class=\"number\">0</span>);</span><br><span class=\"line\">                tableInfo.name = cursor.getString(<span class=\"number\">1</span>);</span><br><span class=\"line\">                tableInfo.type = cursor.getString(<span class=\"number\">2</span>);</span><br><span class=\"line\">                tableInfo.notnull = cursor.getInt(<span class=\"number\">3</span>) == <span class=\"number\">1</span>;</span><br><span class=\"line\">                tableInfo.dfltValue = cursor.getString(<span class=\"number\">4</span>);</span><br><span class=\"line\">                tableInfo.pk = cursor.getInt(<span class=\"number\">5</span>) == <span class=\"number\">1</span>;</span><br><span class=\"line\">                tableInfos.add(tableInfo);</span><br><span class=\"line\">                <span class=\"comment\">// printLog(tableName + &quot;：&quot; + tableInfo);</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            cursor.close();</span><br><span class=\"line\">            <span class=\"keyword\">return</span> tableInfos;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"greendao数据库加密\">GreenDao数据库加密<a title=\"#greendao数据库加密\" href=\"#greendao数据库加密\"></a></h2>\n<p>开发中对于存储于数据库中的敏感数据，我们可以通过对数据库加密来进行保护。GreenDao可以通过SQLCipher来进行加密处理。下面我们简单讲解下加密过程：</p>\n<p>步骤：</p>\n<ol>\n<li>导入加密库文件： <figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">implementation <span class=\"string\">&#x27;net.zetetic:android-database-sqlcipher:3.5.6&#x27;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li>修改DaoSession的生成方式： <figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//       MyDaoMaster helper = new MyDaoMaster(this, &quot;aserbaos.db&quot;);  //数据库升级写法</span></span><br><span class=\"line\">        DaoMaster.DevOpenHelper helper = <span class=\"keyword\">new</span> DaoMaster.DevOpenHelper(<span class=\"keyword\">this</span>, <span class=\"string\">&quot;aserbao.db&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//SQLiteDatabase db = helper.getWritableDatabase(); //不加密的写法</span></span><br><span class=\"line\">        Database db = helper.getEncryptedWritableDb(<span class=\"string\">&quot;aserbao&quot;</span>); <span class=\"comment\">//数据库加密密码为“aserbao&quot;的写法</span></span><br><span class=\"line\">        DaoMaster daoMaster = <span class=\"keyword\">new</span> DaoMaster(db);</span><br><span class=\"line\">        daoSession = daoMaster.newSession();</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<h2 id=\"项目地址\">项目地址<a title=\"#项目地址\" href=\"#项目地址\"></a></h2>\n<p><a href=\"https://github.com/aserbao/AserbaosAndroid\" target=\"_blank\">AserbaosAndroid</a></p>\n<p>当前文章所有代码在AserbaosAndroid/app/src/main/java/com/aserbao/aserbaosandroid/functions/database/greenDao/relation目录下；</p>\n<h2 id=\"参考博客\">参考博客<a title=\"#参考博客\" href=\"#参考博客\"></a></h2>\n<ul>\n<li><a href=\"http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2017/0703/8144.html\" target=\"_blank\">Android ORM 框架：GreenDao 使用详解</a></li>\n<li><a href=\"https://www.cnblogs.com/whoislcj/p/5651396.html\" target=\"_blank\">Android数据存储之GreenDao 3.0 详解</a></li>\n<li><a href=\"https://xujiaojie.github.io/2017/11/22/%E6%8B%86%E8%BD%AE%E5%AD%90%E7%B3%BB%E5%88%97%E4%B9%8BGreenDao%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/\" target=\"_blank\">拆轮子系列之GreenDao框架原理分析</a></li>\n</ul>\n<h2 id=\"修改记录\">修改记录<a title=\"#修改记录\" href=\"#修改记录\"></a></h2>\n<ol>\n<li>\n<p>CreditCard中不能只使用一个useId来做关联，因为我这里Teacher和Student都和CreditCard是一对多关系，所以我们需要建两个对应关系字段。为了分辨添加了studentId和teacherId。</p>\n <figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Entity</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CreditCard</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Id</span></span><br><span class=\"line\">    Long id;</span><br><span class=\"line\">    Long studentId;</span><br><span class=\"line\">    Long teacherId;</span><br><span class=\"line\">    String userName;<span class=\"comment\">//持有者名字</span></span><br><span class=\"line\">    String cardNum;<span class=\"comment\">//卡号</span></span><br><span class=\"line\">    String whichBank;<span class=\"comment\">//哪个银行的</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> cardType;<span class=\"comment\">//卡等级，分类 0 ~ 5</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li>\n<p>Student中的@ToMany（referencedJoinProperty =“id”）这个id对应的是CreditCard中的studentId，不是自增Id。（问题由@山豆几_提出，感谢）</p>\n<p>修改后的代码应该是：</p>\n <figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@ToMany(referencedJoinProperty = &quot;studentId&quot;)</span></span><br><span class=\"line\">    List&lt;CreditCard&gt; creditCardsList;</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<h2 id=\"扩展\">扩展<a title=\"#扩展\" href=\"#扩展\"></a></h2>\n<p>greendao官方已经做的很不错了，但是针对项目开发我们还要写很多东西，项目开发注重的是模块化和组件化，因此这里有另外一篇专门针对greendao处理业务做了一个封装<a href=\"https://blog.csdn.net/sinat_15877283/article/details/51098477\" target=\"_blank\">《DataBase 数据库整理（greenDao示例）》</a>，可以作为参考，我自己的项目则是额外在此基础上又封了一层，业务和API之间做到完全隔离，前边说到greendao已经不再维护了，官方将重心移到了<code>ObjectBox</code>上，我这样做也是方便后期更容易的更替。</p>\n","prev":{"title":"位运算的那些事（一）搞懂机器码","link":"posts/1566742995"},"next":{"title":"对象拷贝性能对比分析","link":"posts/1563597009"},"plink":"https://blog.ixin.run/posts/1563884419/","toc":[{"id":"存储的数据库结构","title":"存储的数据库结构","index":"1"},{"id":"greendao的介绍","title":"GreenDao的介绍","index":"2","children":[{"id":"什么是greendao？","title":"什么是GreenDao？","index":"2.1"},{"id":"greendao的官方文档","title":"GreenDao的官方文档","index":"2.2"},{"id":"greendao的作用","title":"GreenDao的作用","index":"2.3"},{"id":"greendao的优缺点","title":"GreenDao的优缺点","index":"2.4"}]},{"id":"greendao的使用","title":"GreenDao的使用","index":"3","children":[{"id":"导入gradle插件和dao代码生成","title":"导入Gradle插件和Dao代码生成","index":"3.1"},{"id":"创建存储对象实体类","title":"创建存储对象实体类","index":"3.2"}]},{"id":"使用greendao实现增删改查","title":"使用GreenDao实现增删改查","index":"4","children":[{"id":"增","title":"增","index":"4.1"},{"id":"删","title":"删","index":"4.2"},{"id":"改","title":"改","index":"4.3"},{"id":"查","title":"查","index":"4.4"}]},{"id":"querybuilder的使用","title":"QueryBuilder的使用","index":"5","children":[{"id":"使用querybuilder进行查询操作","title":"使用QueryBuilder进行查询操作","index":"5.1"}]},{"id":"注解讲解","title":"注解讲解","index":"6","children":[{"id":"@entity注解","title":"@Entity注解","index":"6.1"},{"id":"基础属性注解（@id，@property，@notnull，@transient）","title":"基础属性注解（@Id，@Property，@NotNull，@Transient）","index":"6.2"},{"id":"索引注解","title":"索引注解","index":"6.3"},{"id":"关系注解","title":"关系注解","index":"6.4"}]},{"id":"一对一，一对多，多对多关系表的创建","title":"一对一，一对多，多对多关系表的创建","index":"7","children":[{"id":"一对一","title":"一对一","index":"7.1"},{"id":"一对多","title":"一对多","index":"7.2"}]},{"id":"greendao数据库加密","title":"GreenDao数据库加密","index":"8"},{"id":"项目地址","title":"项目地址","index":"9"},{"id":"参考博客","title":"参考博客","index":"10"},{"id":"修改记录","title":"修改记录","index":"11"},{"id":"扩展","title":"扩展","index":"12"}],"reward":true,"copyright":{"author":"i猩人","link":"<a href=\"https://blog.ixin.run/posts/1563884419/\" title=\"Android数据库GreenDao的使用完全解析\">https://blog.ixin.run/posts/1563884419/</a>","license":"本文遵循<a href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/\"rel=\"external nofollow\" target=\"_blank\"> CC 4.0 BY-SA </a>版权协议，转载请附上原文出处链接及本声明。"}}