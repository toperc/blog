{"title":"Android开发ContentProvider学习总结","date":"2019-03-09T15:11:30.000Z","date_formatted":{"ll":"2019年3月9日","L":"2019/03/09","MM-DD":"03-09"},"link":"posts/1552144290","comments":true,"tags":["Android"],"categories":["Android"],"updated":"2021-01-29T12:51:44.625Z","content":"<p>ContentProvider是Android四大组件之一，其地位不言而喻。其使用场景就是应用间的数据共享，举个例子：阿里旗下的哥俩app-淘宝和天猫，登录淘宝的时候想引用天猫本地存储的数据，即从天猫本地数据库去查找。这时候天猫说了，老弟啊，你想用我的数据那么你要听我的，只能用我本地的方法去查，给你个URI指令去操作就行。是不是明白了些呢，其实这和webview的js交互如出一辙。</p>\n<a id=\"more\"></a>\n<h2 id=\"什么是contentprovider\">什么是ContentProvider<a title=\"#什么是contentprovider\" href=\"#什么是contentprovider\"></a></h2>\n<p>Android的四大组件之一，主要用于不同的应用程序之间实现数据共享功能，主要作用作为共享方的共享工具构建。</p>\n<p>Android 系统中比如相册、日历、音频、视频、通讯录等模块都提供了 ContentProvider 的访问支持。它的使用非常简单，你可以参考<a href=\"https://developer.android.com/guide/topics/providers/content-providers\" target=\"_blank\">官方文档</a>。</p>\n<h2 id=\"什么是contentresolver\">什么是ContentResolver<a title=\"#什么是contentresolver\" href=\"#什么是contentresolver\"></a></h2>\n<p>数据调用者，ContentProvider提供共享方的数据四大操作功能，调用方通过ContentResolver对象结合Uri进行调用ContentProvider的增删改查功能。</p>\n<h2 id=\"什么是uri\">什么是URI<a title=\"#什么是uri\" href=\"#什么是uri\"></a></h2>\n<p>Uri（通用资源标识符 Universal Resource Identifer），在这里代表数据操作的地址，每一个ContentProvider发布数据时都会有唯一的地址。</p>\n<p>比如：content：//（固定写法）+com.android.contacts(包名，可变)+/contacts（path路径）</p>\n<h2 id=\"什么是urimatcher\">什么是UriMatcher<a title=\"#什么是urimatcher\" href=\"#什么是urimatcher\"></a></h2>\n<p>共享方定义URI匹配规则，将来调用方可根据这些规则定义操作地址（URI）进行数据操作。</p>\n<p>UriMatcher的匹配工作的第一步就是先将所需要的匹配的URI使用addURI（）添加到UriMatcher中，</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">addURI</span><span class=\"params\">(String authority, String path, <span class=\"keyword\">int</span> code)</span></span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>authority:就是URI对应的authority</li>\n<li>path:就是我们在URI中 authority后的那一串</li>\n<li>code:<strong>表示匹配成功以后的返回值</strong>；</li>\n</ul>\n<h2 id=\"contentprovider使用步骤\">ContentProvider使用步骤<a title=\"#contentprovider使用步骤\" href=\"#contentprovider使用步骤\"></a></h2>\n<p>共享方：</p>\n<ol>\n<li>使用SQLite技术，创建好数据库和数据表</li>\n<li>新建类继承ContentProvider</li>\n<li>重写6个抽象方法</li>\n<li>创建UriMatcher，定义Uri规则</li>\n<li>在Manifest中注册provider</li>\n</ol>\n<p>调用方：<br>\nContentResolver对ContentProvider中共享的数据进行增删改查操作</p>\n<h2 id=\"contentprovider实例应用\">ContentProvider实例应用<a title=\"#contentprovider实例应用\" href=\"#contentprovider实例应用\"></a></h2>\n<h3 id=\"共享方所做的工作：\">共享方所做的工作：<a title=\"#共享方所做的工作：\" href=\"#共享方所做的工作：\"></a></h3>\n<p>1.新建类继承ContentProvider</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//新建类继承ContentProvider</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DatabaseProvider</span> <span class=\"keyword\">extends</span> <span class=\"title\">ContentProvider</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> MyDBHelpter myDBHelpter;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TAG = <span class=\"string\">&quot;DatabaseProvider&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//添加整形常亮</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> USER_DIR = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> USER_ITEM = <span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"comment\">//创建authority</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String AUTHORITY = <span class=\"string\">&quot;com.example.administrator.databasetest.provider&quot;</span>;</span><br><span class=\"line\">    <span class=\"comment\">//创建UriMatcher对象</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> UriMatcher uriMatcher;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//创建静态代码块</span></span><br><span class=\"line\">    <span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//实例化UriMatcher对象</span></span><br><span class=\"line\">        uriMatcher = <span class=\"keyword\">new</span> UriMatcher(UriMatcher.NO_MATCH);</span><br><span class=\"line\">        <span class=\"comment\">//可以实现匹配URI的功能</span></span><br><span class=\"line\">        <span class=\"comment\">//参数1：authority 参数2：路径 参数3：自定义代码</span></span><br><span class=\"line\">        uriMatcher.addURI(AUTHORITY, <span class=\"string\">&quot;userdemo&quot;</span>, USER_DIR);</span><br><span class=\"line\">        uriMatcher.addURI(AUTHORITY, <span class=\"string\">&quot;userdemo/#&quot;</span>, USER_ITEM);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">DatabaseProvider</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        Log.e(TAG, <span class=\"string\">&quot;DatabaseProvider: &quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//onCreate()方法</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">onCreate</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//实现创建MyDBHelpter对象</span></span><br><span class=\"line\">        myDBHelpter = <span class=\"keyword\">new</span> MyDBHelpter(getContext(), <span class=\"string\">&quot;userdbdemo&quot;</span>, <span class=\"keyword\">null</span>, <span class=\"number\">1</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//删除数据表数据</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">delete</span><span class=\"params\">(Uri uri, String selection, String[] selectionArgs)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//创建SQLiteDatabase对象</span></span><br><span class=\"line\">        SQLiteDatabase db = myDBHelpter.getWritableDatabase();</span><br><span class=\"line\">        <span class=\"keyword\">int</span> deleteInt = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"comment\">//匹配uri</span></span><br><span class=\"line\">        <span class=\"keyword\">switch</span> (uriMatcher.match(uri)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> USER_DIR:</span><br><span class=\"line\">                <span class=\"comment\">//参数1：表名   参数2：约束删除列的名字   参数3：具体行的值</span></span><br><span class=\"line\">                deleteInt = db.delete(<span class=\"string\">&quot;userdemo&quot;</span>, selection, selectionArgs);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> USER_ITEM:</span><br><span class=\"line\">                String deleteId = uri.getPathSegments().get(<span class=\"number\">1</span>);</span><br><span class=\"line\">                deleteInt = db.delete(<span class=\"string\">&quot;userdemo&quot;</span>, <span class=\"string\">&quot;id=?&quot;</span>, <span class=\"keyword\">new</span> String[]&#123;deleteId&#125;);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">default</span>:</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> deleteInt;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//插入数据</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Uri <span class=\"title\">insert</span><span class=\"params\">(Uri uri, ContentValues values)</span> </span>&#123;</span><br><span class=\"line\">        SQLiteDatabase db = myDBHelpter.getWritableDatabase();</span><br><span class=\"line\">        <span class=\"keyword\">switch</span> (uriMatcher.match(uri)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> USER_DIR:</span><br><span class=\"line\">            <span class=\"keyword\">case</span> USER_ITEM:</span><br><span class=\"line\">                <span class=\"comment\">//参数1：表名  参数2：没有赋值的设为空   参数3：插入值</span></span><br><span class=\"line\">                <span class=\"keyword\">long</span> newUserId = db.insert(<span class=\"string\">&quot;userdemo&quot;</span>, <span class=\"keyword\">null</span>, values);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">default</span>:</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//查询数据</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Cursor <span class=\"title\">query</span><span class=\"params\">(Uri uri, String[] projection, String selection,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                        String[] selectionArgs, String sortOrder)</span> </span>&#123;</span><br><span class=\"line\">        SQLiteDatabase db = myDBHelpter.getWritableDatabase();</span><br><span class=\"line\">        Cursor cursor = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">switch</span> (uriMatcher.match(uri)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> USER_DIR:</span><br><span class=\"line\">                <span class=\"comment\">//参数1：表名  其他参数可借鉴上面的介绍</span></span><br><span class=\"line\">                cursor = db.query(<span class=\"string\">&quot;userdemo&quot;</span>, projection, selection, selectionArgs, <span class=\"keyword\">null</span>, <span class=\"keyword\">null</span>, sortOrder);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> USER_ITEM:</span><br><span class=\"line\">                String queryId = uri.getPathSegments().get(<span class=\"number\">1</span>);</span><br><span class=\"line\">                cursor = db.query(<span class=\"string\">&quot;userdemo&quot;</span>, projection, <span class=\"string\">&quot;id=?&quot;</span>, <span class=\"keyword\">new</span> String[]&#123;queryId&#125;, <span class=\"keyword\">null</span>, <span class=\"keyword\">null</span>, sortOrder);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">default</span>:</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> cursor;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//更新数据</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">update</span><span class=\"params\">(Uri uri, ContentValues values, String selection,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                      String[] selectionArgs)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        SQLiteDatabase db = myDBHelpter.getWritableDatabase();</span><br><span class=\"line\">        <span class=\"keyword\">int</span> updateRow = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">switch</span> (uriMatcher.match(uri)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> USER_DIR:</span><br><span class=\"line\">                updateRow = db.update(<span class=\"string\">&quot;userdemo&quot;</span>,values,selection,selectionArgs);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> USER_ITEM:</span><br><span class=\"line\">                String updateId = uri.getPathSegments().get(<span class=\"number\">1</span>);</span><br><span class=\"line\">                updateRow = db.update(<span class=\"string\">&quot;userdemo&quot;</span>,values,<span class=\"string\">&quot;id=?&quot;</span>,<span class=\"keyword\">new</span> String[]&#123;updateId&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">default</span>:</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> updateRow;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getType</span><span class=\"params\">(Uri uri)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> UnsupportedOperationException(<span class=\"string\">&quot;Not yet implemented&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>2.在Manifest中注册provider</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;provider</span><br><span class=\"line\">   android:name=<span class=\"string\">&quot;.provider.DatabaseProvider&quot;</span></span><br><span class=\"line\">   android:authorities=<span class=\"string\">&quot;com.example.administrator.databasetest.provider&quot;</span></span><br><span class=\"line\">   android:enabled=<span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">   android:exported=<span class=\"string\">&quot;true&quot;</span>/&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"调用方所做的工作：\">调用方所做的工作：<a title=\"#调用方所做的工作：\" href=\"#调用方所做的工作：\"></a></h3>\n<p>在另外一个程序中定义相应的URI操作共享方的数据</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MainActivity</span> <span class=\"keyword\">extends</span> <span class=\"title\">AppCompatActivity</span> <span class=\"keyword\">implements</span> <span class=\"title\">View</span>.<span class=\"title\">OnClickListener</span></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Button insertBtn;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> EditText editText;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Button deleteBtn;</span><br><span class=\"line\">    <span class=\"keyword\">private</span>  Button queryBtn;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Button updateBtn;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span>  String newId;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TAG = <span class=\"string\">&quot;MainActivity&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onCreate</span><span class=\"params\">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>.onCreate(savedInstanceState);</span><br><span class=\"line\">        setContentView(R.layout.activity_main);</span><br><span class=\"line\"></span><br><span class=\"line\">        bangID();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">bangID</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        insertBtn = findViewById(R.id.main_insert_btn);</span><br><span class=\"line\">        editText = findViewById(R.id.main_et);</span><br><span class=\"line\">        deleteBtn = findViewById(R.id.main_delete_btn);</span><br><span class=\"line\">        queryBtn = findViewById(R.id.main_query_btn);</span><br><span class=\"line\">        updateBtn = findViewById(R.id.main_update_btn);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        insertBtn.setOnClickListener(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">        deleteBtn.setOnClickListener(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">        queryBtn.setOnClickListener(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">        updateBtn.setOnClickListener(<span class=\"keyword\">this</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onClick</span><span class=\"params\">(View v)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">switch</span>(v.getId())&#123;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> R.id.main_insert_btn:</span><br><span class=\"line\">                String name = editText.getText().toString();</span><br><span class=\"line\">                <span class=\"comment\">//创建期待匹配的uri</span></span><br><span class=\"line\">                Uri uri1 = Uri.parse(<span class=\"string\">&quot;content://com.example.administrator.databasetest.provider/userdemo&quot;</span>);</span><br><span class=\"line\">                ContentValues values = <span class=\"keyword\">new</span> ContentValues();</span><br><span class=\"line\">                values.put(<span class=\"string\">&quot;name&quot;</span>,name);</span><br><span class=\"line\">                <span class=\"comment\">//获得ContentResolver对象，调用方法</span></span><br><span class=\"line\">                getContentResolver().insert(uri1,values);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> R.id.main_delete_btn:</span><br><span class=\"line\">                String name1 = editText.getText().toString();</span><br><span class=\"line\">                Uri uri2 = Uri.parse(<span class=\"string\">&quot;content://com.example.administrator.databasetest.provider/userdemo&quot;</span>);</span><br><span class=\"line\">                getContentResolver().delete(uri2,<span class=\"string\">&quot;name=?&quot;</span>,<span class=\"keyword\">new</span> String[]&#123;name1&#125;);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> R.id.main_query_btn:</span><br><span class=\"line\">                Uri uri = Uri.parse(<span class=\"string\">&quot;content://com.example.administrator.databasetest.provider/userdemo&quot;</span>);</span><br><span class=\"line\">                Cursor cursor = getContentResolver().query(uri,<span class=\"keyword\">null</span>,<span class=\"keyword\">null</span>,<span class=\"keyword\">null</span>,<span class=\"keyword\">null</span>);</span><br><span class=\"line\">                cursor.moveToFirst();</span><br><span class=\"line\">                <span class=\"keyword\">do</span>&#123;</span><br><span class=\"line\">                    String name2 = cursor.getString(cursor.getColumnIndex(<span class=\"string\">&quot;name&quot;</span>));</span><br><span class=\"line\">                    Log.e(TAG, <span class=\"string\">&quot;onClick: &quot;</span>+name2 );</span><br><span class=\"line\"></span><br><span class=\"line\">                &#125;<span class=\"keyword\">while</span>(cursor.moveToNext());</span><br><span class=\"line\">                cursor.close();</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> R.id.main_update_btn:</span><br><span class=\"line\">                String updateStr = editText.getText().toString();</span><br><span class=\"line\">                Uri uri3 =Uri.parse(<span class=\"string\">&quot;content://com.example.administrator.databasetest.provider/userdemo&quot;</span>);</span><br><span class=\"line\">                ContentValues values1 = <span class=\"keyword\">new</span> ContentValues();</span><br><span class=\"line\">                values1.put(<span class=\"string\">&quot;name&quot;</span>,updateStr);</span><br><span class=\"line\">                getContentResolver().update(uri3,values1,<span class=\"string\">&quot;name=?&quot;</span>,<span class=\"keyword\">new</span> String[]&#123;<span class=\"string\">&quot;&quot;</span>&#125;);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">default</span>:</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"contentprovider使用过程中注意点\">ContentProvider使用过程中注意点<a title=\"#contentprovider使用过程中注意点\" href=\"#contentprovider使用过程中注意点\"></a></h2>\n<p>ContentProvider 在使用过程中也存在一些“暗坑”需要我们特别注意。</p>\n<h3 id=\"启动性能\">启动性能<a title=\"#启动性能\" href=\"#启动性能\"></a></h3>\n<p>ContentProvider 的生命周期默认在 Application onCreate() 之前，而且都是在主线程创建的。我们自定义的 ContentProvider 类的构造函数、静态代码块、onCreate 函数都尽量不要做耗时的操作，会拖慢启动速度。<br>\n<img src=\"https://note.youdao.com/yws/api/personal/file/6D73D3FD9D88494682DC9C5D6A3E89F0?method=download&amp;shareKey=fa9e31298a3053f85ef1549a41fc5d4e\" alt=\"ContentProvider启动时机\"></p>\n<h3 id=\"稳定性\">稳定性<a title=\"#稳定性\" href=\"#稳定性\"></a></h3>\n<p>ContentProvider 在进行跨进程数据传递时，利用了 Android 的 Binder 和匿名共享内存机制。简单来说，就是通过 Binder 传递 CursorWindow 对象内部的匿名共享内存的文件描述符。这样在跨进程传输中，结果数据并不需要跨进程传输，而是在不同进程中通过传输的匿名共享内存文件描述符来操作同一块匿名内存，这样来实现不同进程访问相同数据的目的。<br>\n<img src=\"https://note.youdao.com/yws/api/personal/file/A15FD04C9124468E9780776A4674722B?method=download&amp;shareKey=377577ebeda7b4617ee70fd6ef7706c6\" alt=\"ContentProvider数据传递机制\"></p>\n<p>基于 mmap 的匿名共享内存机制也是有代价的。当传输的数据量非常小的时候，可能不一定划算。所以 ContentProvider 提供了一种 call 函数，它会直接通过 Binder 来传输数据。</p>\n<p>Android 的 Binder 传输是有大小限制的，一般来说限制是 1 ~ 2MB。ContentProvider 的接口调用参数和 call 函数调用并没有使用匿名共享机制，比如要批量插入很多数据，那么就会出现一个插入数据的数组，如果这个数组太大了，那么这个操作就可能出现数据超大异常。</p>\n<h3 id=\"安全性\">安全性<a title=\"#安全性\" href=\"#安全性\"></a></h3>\n<p>虽然 ContentProvider 为应用程序之间的数据共享提供了很好的安全机制，但是如果 ContentProvider 是 exported，当支持执行 SQL 语句时就需要注意 SQL 注入的问题。另外如果我们传入的参数是一个文件路径，然后返回文件内容，这个时候也要校验合法性，不然整个应用的私有数据都有可能被别人拿到，在 Intent 传递参数的时候可能会经常会犯这个错误。</p>\n<h2 id=\"参考\">参考<a title=\"#参考\" href=\"#参考\"></a></h2>\n<ul>\n<li><a href=\"https://blog.csdn.net/harvic880925/article/details/44521461\">https://blog.csdn.net/harvic880925/article/details/44521461</a></li>\n<li><a href=\"https://blog.csdn.net/shaochen2015821426/article/details/79748487?depth_1-utm_source=distribute.pc_relevant.none-task&amp;utm_source=distribute.pc_relevant.none-task#commentBox\">https://blog.csdn.net/shaochen2015821426/article/details/79748487?depth_1-utm_source=distribute.pc_relevant.none-task&amp;utm_source=distribute.pc_relevant.none-task#commentBox</a></li>\n<li><a href=\"https://www.jianshu.com/p/41391e96ce48\">https://www.jianshu.com/p/41391e96ce48</a></li>\n</ul>\n","prev":{"title":"Android开发通知栏的那些事","link":"posts/1552921890"},"next":{"title":"URL和URI的区别","link":"posts/1552038469"},"plink":"https://blog.ixin.run/posts/1552144290/","toc":[{"id":"什么是contentprovider","title":"什么是ContentProvider","index":"1"},{"id":"什么是contentresolver","title":"什么是ContentResolver","index":"2"},{"id":"什么是uri","title":"什么是URI","index":"3"},{"id":"什么是urimatcher","title":"什么是UriMatcher","index":"4"},{"id":"contentprovider使用步骤","title":"ContentProvider使用步骤","index":"5"},{"id":"contentprovider实例应用","title":"ContentProvider实例应用","index":"6","children":[{"id":"共享方所做的工作：","title":"共享方所做的工作：","index":"6.1"},{"id":"调用方所做的工作：","title":"调用方所做的工作：","index":"6.2"}]},{"id":"contentprovider使用过程中注意点","title":"ContentProvider使用过程中注意点","index":"7","children":[{"id":"启动性能","title":"启动性能","index":"7.1"},{"id":"稳定性","title":"稳定性","index":"7.2"},{"id":"安全性","title":"安全性","index":"7.3"}]},{"id":"参考","title":"参考","index":"8"}],"reward":true,"copyright":{"author":"i猩人","link":"<a href=\"https://blog.ixin.run/posts/1552144290/\" title=\"Android开发ContentProvider学习总结\">https://blog.ixin.run/posts/1552144290/</a>","license":"本文遵循<a href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/\"rel=\"external nofollow\" target=\"_blank\"> CC 4.0 BY-SA </a>版权协议，转载请附上原文出处链接及本声明。"}}