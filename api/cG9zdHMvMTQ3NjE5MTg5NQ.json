{"title":"Android开发之WebView详细总结","date":"2016-10-11T13:18:15.000Z","date_formatted":{"ll":"2016年10月11日","L":"2016/10/11","MM-DD":"10-11"},"link":"posts/1476191895","comments":true,"categories":["Android"],"updated":"2021-01-29T12:51:44.635Z","content":"<p>WebView是android开发中专门用来加载网页的一种控件，常用于混合式开发，它采用WebKit渲染引擎来显示网页包括控制网页的前进、后退、放大、缩小、执行文本、搜索等功能。WebKit是一种让网页浏览器绘制网页的排版引擎，被用于Apple Safari，其分支也用于基于Chromuim的网页浏览器，详细了解可移步于https://zh.wikipedia.org/zh/WebKit 。</p>\n<a id=\"more\"></a>\n<h2 id=\"注册\">注册<a title=\"#注册\" href=\"#注册\"></a></h2>\n<p>WebView使用时一般情况下要远程加载，必须在AndroidManifest文件中注册网络权限：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;uses-permission android:name=<span class=\"string\">&quot;android.permission.INTERNET&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>\n<p>如果还要涉及到定位，还要注册定位权限：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;uses-permission android:name=<span class=\"string\">&quot;android.permission.ACCESS_FINE_LOCATION&quot;</span>/&gt;</span><br><span class=\"line\">&lt;uses-permission android:name=<span class=\"string\">&quot;android.permission.ACCESS_COARSE_LOCATION&quot;</span>/&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"加载方式\">加载方式<a title=\"#加载方式\" href=\"#加载方式\"></a></h2>\n<p>//加载一个网页</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">webView.loadUrl(&quot;http:&#x2F;&#x2F;www.google.com&#x2F;&quot;);</span><br></pre></td></tr></table></figure>\n<p>//加载项目中的一个html页面</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">webView.loadUrl(&quot;file:&#x2F;&#x2F;&#x2F;android_asset&#x2F;test.html&quot;);</span><br></pre></td></tr></table></figure>\n<p>//加载手机本地的一个html页面的方法</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">webView.loadUrl(&quot;content:&#x2F;&#x2F;com.android.htmlfileprovider&#x2F;sdcard&#x2F;test.html&quot;);</span><br></pre></td></tr></table></figure>\n<p>//加载一段Html代码</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">loadData(String data, String mimeType, String encoding);</span><br><span class=\"line\">loadDataWithBaseURL(String baseUrl, String data, String mimeType, String encoding, String historyUrl);</span><br></pre></td></tr></table></figure>\n<p>例：webView.loadDataWithBaseURL(null, htmlContent, “text/html”, “UTF-8”,null);<br>\n区别：loadDataWithBaseURL()比loadData()多两个参数，可以指定HTML代码片段中相关资源的相对根路径，也可以指定历史Url。两个方法的其余三个参数相同。但是loadData()中的html data中不能包含’#', ‘%’, ‘’, '?'四中特殊字符，使用时我们需要用UrlEncoder编码为%23, %25, %27, %3f 。</p>\n<h2 id=\"websettings\">WebSettings<a title=\"#websettings\" href=\"#websettings\"></a></h2>\n<p>WebSettings类主要针对webview做一些相关的设置，包括自适应屏幕、缩放设置、js脚本控制、网页数据缓存等。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">WebSettings webSettings = webView.getSettings();</span><br><span class=\"line\"><span class=\"comment\">// 设置自适应屏幕</span></span><br><span class=\"line\">webSettings.setUseWideViewPort(<span class=\"keyword\">true</span>);           <span class=\"comment\">//设置成webview推荐使用的窗口，可任意比例缩放</span></span><br><span class=\"line\">webSettings.setLoadWithOverviewMode(<span class=\"keyword\">true</span>);      <span class=\"comment\">//设置成webview加载的页面大小的模式，</span></span><br><span class=\"line\"><span class=\"comment\">// 设置缩放网页</span></span><br><span class=\"line\">webSettings.setSupportZoom(<span class=\"keyword\">true</span>);               <span class=\"comment\">//是否支持屏幕双击缩放，但是下边的是前提</span></span><br><span class=\"line\">webSettings.setBuiltInZoomControls(<span class=\"keyword\">true</span>);       <span class=\"comment\">//是否支持内置按钮缩放和手势“捏”缩放，如果设为false则webview不支持缩放功能</span></span><br><span class=\"line\">webSettings.setDisplayZoomControls(<span class=\"keyword\">false</span>);      <span class=\"comment\">//是否隐藏原生的缩放控件</span></span><br><span class=\"line\"><span class=\"comment\">// 设置可以执行Javascript脚本</span></span><br><span class=\"line\">webSettings.setJavaScriptEnabled(<span class=\"keyword\">true</span>);</span><br><span class=\"line\"><span class=\"comment\">// 设置缓存网页数据</span></span><br><span class=\"line\">webSettings.setDomStorageEnabled(<span class=\"keyword\">true</span>);         <span class=\"comment\">//开启 DOM storage API 功能</span></span><br><span class=\"line\">webSettings.setDatabaseEnabled(<span class=\"keyword\">true</span>);           <span class=\"comment\">//开启 database storage API 功能</span></span><br><span class=\"line\">webSettings.setAppCacheEnabled(<span class=\"keyword\">true</span>);           <span class=\"comment\">//开启 Application Caches 功能</span></span><br><span class=\"line\"><span class=\"comment\">// 设置支持多窗口,要复写 WebChromeClient的onCreateWindow方法</span></span><br><span class=\"line\">webSettings.setSupportMultipleWindows(<span class=\"keyword\">true</span>);    <span class=\"comment\">//支持多窗口</span></span><br><span class=\"line\">webSettings.setJavaScriptCanOpenWindowsAutomatically(<span class=\"keyword\">true</span>);  <span class=\"comment\">//支持js打开新窗口</span></span><br><span class=\"line\"><span class=\"comment\">// 支持自动加载图片</span></span><br><span class=\"line\">webSettings.setLoadsImagesAutomatically(<span class=\"keyword\">true</span>);</span><br><span class=\"line\"><span class=\"comment\">// 设置编码格式</span></span><br><span class=\"line\">webSettings.setDefaultTextEncodingName(<span class=\"string\">&quot;utf-8&quot;</span>);</span><br></pre></td></tr></table></figure>\n<h2 id=\"缓存设置\">缓存设置<a title=\"#缓存设置\" href=\"#缓存设置\"></a></h2>\n<p>webview中的缓存模式有四种：</p>\n<ul>\n<li>LOAD_CACHE_ONLY: 不使用网络，只读取本地缓存数据</li>\n<li>LOAD_DEFAULT: （默认）根据cache-control决定是否从网络上取数据。</li>\n<li>LOAD_NO_CACHE: 不使用缓存，只从网络获取数据.</li>\n<li>LOAD_CACHE_ELSE_NETWORK，只要本地有，无论是否过期，或者no-cache，都使用缓存中的数据。</li>\n</ul>\n<p>根据网络合理加载网络数据：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (NetStatusUtil.isConnected(getApplicationContext())) &#123;</span><br><span class=\"line\">    webSettings.setCacheMode(WebSettings.LOAD_DEFAULT);<span class=\"comment\">//有网，根据cache-control决定是否从网络上取数据。</span></span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    webSettings.setCacheMode(WebSettings.LOAD_CACHE_ELSE_NETWORK); <span class=\"comment\">//没网，则从本地获取，即离线加载</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">String appCachePath = getApplicationContext().getCacheDir().getAbsolutePath();</span><br><span class=\"line\">webSettings.setAppCachePath(appCachePath);      <span class=\"comment\">//设置缓存数据目录</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"字体大小控制\">字体大小控制<a title=\"#字体大小控制\" href=\"#字体大小控制\"></a></h2>\n<p>Android版本4.0之前WebView支持字体大小分为5中：</p>\n<ul>\n<li>SMALLEST(50%),</li>\n<li>SMALLER(75%),</li>\n<li>NORMAL(100%),</li>\n<li>LARGER(150%),</li>\n<li>LARGEST(200%);</li>\n</ul>\n<p>设定字体大小：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">webSettings.setTextSize(TextSize.SMALLER);</span><br></pre></td></tr></table></figure>\n<p>Android4.0之后WebView使用起来更加灵活，可采用setTextZoom(int)设置字体大小，参数默认是100。上边的方法已经舍弃。</p>\n<h2 id=\"webviewclient\">WebViewClient<a title=\"#webviewclient\" href=\"#webviewclient\"></a></h2>\n<p>主要展示webview网页加载的一个过程，用于帮助webview处理一些请求事件和通知。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">WebViewClient webViewClient = <span class=\"keyword\">new</span> WebViewClient()&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//超链接加载,打开网页时不调用系统浏览器，而是在本WebView中显示。也可捕获超链接url,做相关操作</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">shouldOverrideUrlLoading</span><span class=\"params\">(WebView view, String url)</span> </span>&#123;</span><br><span class=\"line\">        view.loadUrl(url);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;    <span class=\"comment\">//返回true表示在当前浏览器中加载</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//网页开始加载</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onPageStarted</span><span class=\"params\">(WebView view, String url, Bitmap favicon)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>.onPageStarted(view, url, favicon);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//网页加载结束</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onPageFinished</span><span class=\"params\">(WebView view, String url)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>.onPageFinished(view, url);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//网页加载失败</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onReceivedError</span><span class=\"params\">(WebView view, WebResourceRequest request, WebResourceError error)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>.onReceivedError(view, request, error);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//对Https的支持</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onReceivedSslError</span><span class=\"params\">(WebView view, SslErrorHandler handler, SslError error)</span> </span>&#123;</span><br><span class=\"line\">        handler.proceed();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//针对页面中每一个资源都会调用一次，用于捕获页面资源</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onLoadResource</span><span class=\"params\">(WebView view, String url)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>.onLoadResource(view, url);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>WebView调用：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">webView.setWebViewClient(webViewClient);</span><br></pre></td></tr></table></figure>\n<h2 id=\"webchromeclient\">WebChromeClient<a title=\"#webchromeclient\" href=\"#webchromeclient\"></a></h2>\n<p>WebChromeClient主要辅助WebView处理Javascript的对话框、网站图标、网站title、加载进度等。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">WebChromeClient webChromeClient = <span class=\"keyword\">new</span> WebChromeClient()&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//获取网页加载进度</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onProgressChanged</span><span class=\"params\">(WebView view, <span class=\"keyword\">int</span> newProgress)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (newProgress &lt; <span class=\"number\">100</span>) &#123;</span><br><span class=\"line\">            String progress = newProgress + <span class=\"string\">&quot;%&quot;</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>.onProgressChanged(view, newProgress);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//=========捕获网页标题信息==========================================================</span></span><br><span class=\"line\">    <span class=\"comment\">//获取标题</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onReceivedTitle</span><span class=\"params\">(WebView view, String title)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>.onReceivedTitle(view, title);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">//获取标题ICON</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onReceivedIcon</span><span class=\"params\">(WebView view, Bitmap icon)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>.onReceivedIcon(view, icon);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//=========捕获弹框信息==========================================================</span></span><br><span class=\"line\">    <span class=\"comment\">//警告框</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">onJsAlert</span><span class=\"params\">(WebView view, String url, String message, JsResult result)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(message!=<span class=\"keyword\">null</span>)&#123;</span><br><span class=\"line\">            <span class=\"comment\">//TODO</span></span><br><span class=\"line\">            <span class=\"comment\">//捕获网页中弹框信息</span></span><br><span class=\"line\">            Toast.makeText(getApplicationContext(), message, Toast.LENGTH_LONG).show();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        result.cancel();   <span class=\"comment\">//</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;       <span class=\"comment\">//表示确认进行捕获</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">   </span><br><span class=\"line\">    <span class=\"comment\">//确认框，会返回布尔值类型，通过这个值可判断点击时是确定还是取消，确定为true，取消为false</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">onJsConfirm</span><span class=\"params\">(WebView view, String url, String message, JsResult result)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.onJsConfirm(view, url, message, result);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//输入框，会返回输入框中的值，点击取消返回null</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">onJsPrompt</span><span class=\"params\">(WebView view, String url, String message, String defaultValue, JsPromptResult result)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.onJsPrompt(view, url, message, defaultValue, result);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//=========HTML5定位==========================================================</span></span><br><span class=\"line\">    <span class=\"comment\">//需要先加入权限</span></span><br><span class=\"line\">    <span class=\"comment\">//&lt;uses-permission android:name=&quot;android.permission.ACCESS_FINE_LOCATION&quot;/&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">//&lt;uses-permission android:name=&quot;android.permission.ACCESS_COARSE_LOCATION&quot;/&gt;</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onGeolocationPermissionsHidePrompt</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>.onGeolocationPermissionsHidePrompt();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onGeolocationPermissionsShowPrompt</span><span class=\"params\">(<span class=\"keyword\">final</span> String origin, <span class=\"keyword\">final</span> GeolocationPermissions.Callback callback)</span> </span>&#123;</span><br><span class=\"line\">        callback.invoke(origin, <span class=\"keyword\">true</span>, <span class=\"keyword\">false</span>);  <span class=\"comment\">//注意个函数，第二个参数就是是否同意定位权限，第三个是是否希望内核记住</span></span><br><span class=\"line\">        <span class=\"keyword\">super</span>.onGeolocationPermissionsShowPrompt(origin, callback);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//=========HTML5多窗口=========================================================</span></span><br><span class=\"line\">    <span class=\"comment\">//WebSettings要支持多窗口</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">onCreateWindow</span><span class=\"params\">(WebView view, <span class=\"keyword\">boolean</span> isDialog, <span class=\"keyword\">boolean</span> isUserGesture, Message resultMsg)</span> </span>&#123;</span><br><span class=\"line\">        WebView.WebViewTransport transport = (WebView.WebViewTransport) resultMsg.obj;</span><br><span class=\"line\">        transport.setWebView(webView);</span><br><span class=\"line\">        resultMsg.sendToTarget();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onCloseWindow</span><span class=\"params\">(WebView window)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>.onCloseWindow(window);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>WebView调用：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">webView.setWebChromeClient(webChromeClient);</span><br></pre></td></tr></table></figure>\n<h2 id=\"支持文件下载\">支持文件下载<a title=\"#支持文件下载\" href=\"#支持文件下载\"></a></h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DownloadListener downloadListener = <span class=\"keyword\">new</span> DownloadListener() &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onDownloadStart</span><span class=\"params\">(String url, String userAgent, String contentDisposition, String mimetype, <span class=\"keyword\">long</span> contentLength)</span> </span>&#123;</span><br><span class=\"line\">        Uri uri = Uri.parse(url);</span><br><span class=\"line\">        Intent intent = <span class=\"keyword\">new</span> Intent(Intent.ACTION_VIEW, uri);</span><br><span class=\"line\">        startActivity(intent);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>WebView调用：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">webView.setDownloadListener(downloadListener);</span><br></pre></td></tr></table></figure>\n<h2 id=\"js交互\">JS交互<a title=\"#js交互\" href=\"#js交互\"></a></h2>\n<p>js交互说白了就两种形式，一种是由webview中的java方法去调用html中的js方法。另一种是html调用webview中java方法。注意在android4.2之前webview有一个漏洞，外部可通过反射来获取手机的联系方式等隐私，4.2以上官方已经修复，可在每个交互方法上添加一个注解“@JavascriptInterface”便可解决，漏洞详情可参阅：<a href=\"http://blog.csdn.net/leehong2005/article/details/11808557\">http://blog.csdn.net/leehong2005/article/details/11808557</a></p>\n<p>webview设置对js的支持：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">webSettings.setJavaScriptEnabled(true);</span><br></pre></td></tr></table></figure>\n<p>webview添加js交互接口：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">webView.addJavascriptInterface(new JSInterface(),&quot;jsinterface&quot;);</span><br></pre></td></tr></table></figure>\n<p>封装js交互类：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">JSInterface</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//js中可以通过：window.jsinterface.JS2Java();调用java无参方法。</span></span><br><span class=\"line\">        <span class=\"meta\">@JavascriptInterface</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">JS2Java</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">            runOnUiThread(<span class=\"keyword\">new</span> Runnable() &#123;</span><br><span class=\"line\">                <span class=\"meta\">@Override</span></span><br><span class=\"line\">                <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                    Toast.makeText(WebViewActivity.<span class=\"keyword\">this</span>,<span class=\"string\">&quot;js调用java无参方法。&quot;</span>,Toast.LENGTH_SHORT).show();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//js中可以通过：window.jsinterface.JS2Java(&#x27;hello java&#x27;);调用java有参方法,并传参&#x27;hello java&#x27;。</span></span><br><span class=\"line\">        <span class=\"meta\">@JavascriptInterface</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">JS2Java</span><span class=\"params\">(<span class=\"keyword\">final</span> String str)</span></span>&#123;</span><br><span class=\"line\">            runOnUiThread(<span class=\"keyword\">new</span> Runnable() &#123;</span><br><span class=\"line\">                <span class=\"meta\">@Override</span></span><br><span class=\"line\">                <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                    Toast.makeText(WebViewActivity.<span class=\"keyword\">this</span>,<span class=\"string\">&quot;js调用java有参方法，js传递的参数是：&quot;</span>+str,Toast.LENGTH_SHORT).show();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//Java调用JS中的无参方法</span></span><br><span class=\"line\">        <span class=\"meta\">@JavascriptInterface</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Java2JS</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">            webView.loadUrl(<span class=\"string\">&quot;javascript: fromJS1()&quot;</span>);</span><br><span class=\"line\">            Log.e(<span class=\"string\">&quot;TAG&quot;</span>,<span class=\"string\">&quot;java调用js中的无参方法&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//Java调用JS中的有参方法，并传参数给js</span></span><br><span class=\"line\">        <span class=\"meta\">@JavascriptInterface</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Java2JS</span><span class=\"params\">(<span class=\"keyword\">final</span> String str)</span></span>&#123;</span><br><span class=\"line\">            webView.loadUrl(<span class=\"string\">&quot;javascript: fromJS2(&#x27;&quot;</span>+str+<span class=\"string\">&quot;&#x27;)&quot;</span>);</span><br><span class=\"line\">            Log.e(<span class=\"string\">&quot;TAG&quot;</span>,<span class=\"string\">&quot;java调用js中的有参方法&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>webview调用js中的方法:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//调用js有参方法</span></span><br><span class=\"line\">        js_has_args_bt.setOnClickListener(<span class=\"keyword\">new</span> View.OnClickListener() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onClick</span><span class=\"params\">(View v)</span> </span>&#123;</span><br><span class=\"line\">                <span class=\"keyword\">new</span> JSInterface().Java2JS(<span class=\"string\">&quot;hello js&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br></pre></td></tr></table></figure>\n<h2 id=\"webview相关方法\">WebView相关方法<a title=\"#webview相关方法\" href=\"#webview相关方法\"></a></h2>\n<ul>\n<li>前进，后退<br>\ngoBack()       //后退<br>\ngoForward()    //前进<br>\ngoBackOrForward(intsteps) //以当前的index为起始点前进或者后退到历史记录中指定的steps，如果steps为负数则为后退，正数则为前进<br>\ncanGoForward()  //是否可以前进<br>\ncanGoBack()     //是否可以后退</li>\n<li>清除缓存<br>\nclearCache(true)   //清除网页访问留下的缓存，由于内核缓存是全局的因此这个方法不仅仅针对webview而是针对整个应用程序.<br>\nclearHistory()     //清除当前webview访问的历史记录，只会webview访问历史记录里的所有记录除了当前访问记录.<br>\nclearFormData()    //清除自动完成填充的表单数据，不会清除WebView存储到本地的数据。</li>\n<li>WebView状态<br>\nonResume()   //激活WebView为活跃状态，能正常执行网页的响应<br>\nonPause()    //WebView处于暂停状态，onPause动作通知内核暂停所有的动作，比如DOM的解析、plugin的执行、JavaScript执行。<br>\npauseTimers()    //暂停所有webview的layout，parsing，javascripttimer。降低CPU功耗。<br>\nresumeTimers()   //恢复pauseTimers时的动作。<br>\ndestroy()    //销毁，关闭了Activity时，音乐或视频，还在播放。就必须销毁。</li>\n<li>重新加载网页<br>\nreload()<br>\n重新加载网页将会重新调用WebClient类中的方法。</li>\n<li>判断WebView滚动到顶端还是低端</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 已经处于底端</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (webView.getContentHeight() * webView.getScale() == (webView.getHeight() + webView.getScrollY())) &#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 处于顶端</span></span><br><span class=\"line\"><span class=\"keyword\">if</span>(webView.getScrollY() == <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>退到后台关闭暂停音乐视频播放</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onPause</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">       <span class=\"keyword\">super</span>.onPause();</span><br><span class=\"line\">       webView.onPause();</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onResume</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">       <span class=\"keyword\">super</span>.onResume();</span><br><span class=\"line\">       webView.onResume();</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>设置手机返回按键监听</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">onKeyDown</span><span class=\"params\">(<span class=\"keyword\">int</span> keyCode, KeyEvent event)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (keyCode == KeyEvent.KEYCODE_BACK &amp;&amp; webView.canGoBack()) &#123;</span><br><span class=\"line\">        webView.goBack();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    finish();</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.onKeyDown(keyCode, event);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>Activity退出销毁WebView<br>\n这一步主要防止内存溢出，webview调用destory时,自定义webview仍绑定在Activity上.这是由于自定义webview构建时传入了该Activity的context对象,因此需要先从父容器中移除webview,然后再销毁webview。</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onDestroy</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (webView != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        webView.loadDataWithBaseURL(<span class=\"keyword\">null</span>, <span class=\"string\">&quot;&quot;</span>, <span class=\"string\">&quot;text/html&quot;</span>, <span class=\"string\">&quot;utf-8&quot;</span>, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">        webView.clearHistory();</span><br><span class=\"line\"></span><br><span class=\"line\">        ((ViewGroup) webView.getParent()).removeView(webView);</span><br><span class=\"line\">        webView.destroy();</span><br><span class=\"line\">        webView = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">super</span>.onDestroy();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>以上是个人总结WebView掌握的知识点，其他细节请移步官方文档查阅清楚，另外在系统级别4.4以上有一个开源引擎crosswalk对H5支持很好，可参阅crosswalk官方文档https://crosswalk-project.org/ 进行学习。</p>\n","prev":{"title":"Java反射你知道多少","link":"posts/1479635474"},"next":{"title":"TCP/IP协议三次握手和四次挥手大白话解说","link":"posts/1474374781"},"plink":"https://blog.ixin.run/posts/1476191895/","toc":[{"id":"注册","title":"注册","index":"1"},{"id":"加载方式","title":"加载方式","index":"2"},{"id":"websettings","title":"WebSettings","index":"3"},{"id":"缓存设置","title":"缓存设置","index":"4"},{"id":"字体大小控制","title":"字体大小控制","index":"5"},{"id":"webviewclient","title":"WebViewClient","index":"6"},{"id":"webchromeclient","title":"WebChromeClient","index":"7"},{"id":"支持文件下载","title":"支持文件下载","index":"8"},{"id":"js交互","title":"JS交互","index":"9"},{"id":"webview相关方法","title":"WebView相关方法","index":"10"}],"reward":true,"copyright":{"author":"i猩人","link":"<a href=\"https://blog.ixin.run/posts/1476191895/\" title=\"Android开发之WebView详细总结\">https://blog.ixin.run/posts/1476191895/</a>","license":"本文遵循<a href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/\"rel=\"external nofollow\" target=\"_blank\"> CC 4.0 BY-SA </a>版权协议，转载请附上原文出处链接及本声明。"}}